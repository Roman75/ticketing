<html>
<head>
    <title>API - Tests</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/libs/jquery.min.js"></script>
    <script src="/libs/lodash.js"></script>
	<script type="text/javascript">
		<!--
		$.urlParam = function(name){
			var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
			return results[1] || 0;
		}
		-->
	</script>
    <style>
        html body {
            width: 100%;
            height: 100%;
            margin: 0px;
            padding: 0px;
        }
    </style>
</head>
<body>
<h1>API - Tests</h1>
<ul id="links">
    <li><a href="actions/create_account.html">create_user.html</a></li>
</ul>
<p>json:</p>
<p>
    <textarea style="width:100%;height:200px;"></textarea><br/>
    <select>
        <option value="">select event</option>
        <option value="login">login</option>
        <option value="list">list</option>
        <option value="mock_data">mock_data</option>
    </select>
    <button>send</button>
</p>
<p>result:</p>
<div></div>
</body>
<script>
	$(function() {
		var token = $.urlParam('token');
		if (token) {
			var socket = io('localhost', {'query': {'token': token}});
			socket.on('connect', function() {
				socket.emit('register', {'type': 'api-tests'});
			});

			socket.on('register', function(items) {
				console.log('on', items);
				var html = '';
				_.each(items, function(item) {
					html += '<li><a href="actions/' + item + '">' + item + '</a></li>';
				});
				$(document).find('ul').html(html);
			});

			socket.on('login', function(res) {
				console.log('on', res);
				var html = '' + JSON.stringify(res) + '<br/>';
				$('div').html(html);
			});

			socket.on('mock_data', function(res) {
				console.log('on', res);
			});

			socket.on('err', function(err) {
				console.warn('err', err);
				$('div').html(JSON.stringify(err));
			});

			socket.on('disconnect', function() {
			});

			$('select').change(function(evt, val) {
				switch ($(evt.currentTarget).val()) {
					case 'login':
						$('textarea').val('{"username": "admin", "password": "admin"}')
						break;
					case 'list':
						$('textarea').val('{"username": "admin", "password": "admin"}')
						break;
					case 'mock_data':
						$('textarea').val('{"orderby": "last_name"}')
						break;
					default:
				}
			});

			$('button').click(function() {
				var evt = $('select').val();
				var val = $('textarea').val();
				if (val) {
					var json = JSON.parse(val);
					console.log('emit', evt, json);
					socket.emit(evt, json);
				}
			});

			var $a = $('body').find('#links').find('a');
			_.each($a, function(a) {
				$(a).attr('href', $(a).attr('href') + '?token=' + token);
			});
		}
	});
</script>
</html>