<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>modules/user/shopping_cart.js - Documentation</title>
    
    
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://myproject.com" target="_blank" class="menu-item" id="website_link" >Project Website</a></h2><h2><a href="https://myproject.com.forum" target="_blank" class="menu-item" id="forum_link" >Forum</a></h2><h3>Namespaces</h3><ul><li></li></ul><h3>Classes</h3><ul><li><a href="MySql.html">MySql</a><ul class='methods'><li data-type='method' style='display: none;'><a href="MySql.html#query">query</a></li><li data-type='method' style='display: none;'><a href="MySql.html#promiseQuery">promiseQuery</a></li><li data-type='method' style='display: none;'><a href="MySql.html#promiseInsert">promiseInsert</a></li><li data-type='method' style='display: none;'><a href="MySql.html#promiseSelect">promiseSelect</a></li><li data-type='method' style='display: none;'><a href="MySql.html#promiseUpdate">promiseUpdate</a></li><li data-type='method' style='display: none;'><a href="MySql.html#promiseDelete">promiseDelete</a></li><li data-type='method' style='display: none;'><a href="MySql.html#promiseCount">promiseCount</a></li><li data-type='method' style='display: none;'><a href="MySql.html#promiseArchive">promiseArchive</a></li><li data-type='method' style='display: none;'><a href="MySql.html#_where">_where</a></li><li data-type='method' style='display: none;'><a href="MySql.html#_order">_order</a></li><li data-type='method' style='display: none;'><a href="MySql.html#_log">_log</a></li></ul></li><li><a href="Helpers.html">Helpers</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Helpers.html#generateUUID">generateUUID</a></li><li data-type='method' style='display: none;'><a href="Helpers.html#getDateTime">getDateTime</a></li><li data-type='method' style='display: none;'><a href="Helpers.html#_logMessage">_logMessage</a></li><li data-type='method' style='display: none;'><a href="Helpers.html#_logError">_logError</a></li><li data-type='method' style='display: none;'><a href="Helpers.html#logSocketMessage">logSocketMessage</a></li><li data-type='method' style='display: none;'><a href="Helpers.html#logSocketError">logSocketError</a></li></ul></li><li><a href="Http.html">Http</a></li><li><a href="Event.html">Event</a></li><li><a href="Floor.html">Floor</a></li><li><a href="List.html">List</a><ul class='methods'><li data-type='method' style='display: none;'><a href="List.html#create">create</a></li><li data-type='method' style='display: none;'><a href="List.html#update">update</a></li><li data-type='method' style='display: none;'><a href="List.html#init">init</a></li><li data-type='method' style='display: none;'><a href="List.html#fetch">fetch</a></li><li data-type='method' style='display: none;'><a href="List.html#_promiseList">_promiseList</a></li><li data-type='method' style='display: none;'><a href="List.html#_promiseListColumn">_promiseListColumn</a></li></ul></li><li><a href="Location.html">Location</a></li><li><a href="Module.html">Module</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Module.html#create">create</a></li><li data-type='method' style='display: none;'><a href="Module.html#update">update</a></li><li data-type='method' style='display: none;'><a href="Module.html#delete">delete</a></li><li data-type='method' style='display: none;'><a href="Module.html#fetch">fetch</a></li><li data-type='method' style='display: none;'><a href="Module.html#fetchAll">fetchAll</a></li><li data-type='method' style='display: none;'><a href="Module.html#getConnID">getConnID</a></li><li data-type='method' style='display: none;'><a href="Module.html#getConnUserID">getConnUserID</a></li><li data-type='method' style='display: none;'><a href="Module.html#getError">getError</a></li><li data-type='method' style='display: none;'><a href="Module.html#generateUUID">generateUUID</a></li><li data-type='method' style='display: none;'><a href="Module.html#getDateTime">getDateTime</a></li><li data-type='method' style='display: none;'><a href="Module.html#_logMessage">_logMessage</a></li><li data-type='method' style='display: none;'><a href="Module.html#_logError">_logError</a></li><li data-type='method' style='display: none;'><a href="Module.html#logSocketMessage">logSocketMessage</a></li><li data-type='method' style='display: none;'><a href="Module.html#logSocketError">logSocketError</a></li></ul></li><li><a href="Order.html">Order</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Order.html#create">create</a></li><li data-type='method' style='display: none;'><a href="Order.html#delete">delete</a></li><li data-type='method' style='display: none;'><a href="Order.html#cancel">cancel</a></li><li data-type='method' style='display: none;'><a href="Order.html#calculate">calculate</a></li><li data-type='method' style='display: none;'><a href="Order.html#_createOrderDetail">_createOrderDetail</a></li><li data-type='method' style='display: none;'><a href="Order.html#_createOrderTax">_createOrderTax</a></li><li data-type='method' style='display: none;'><a href="Order.html#_createPDF">_createPDF</a></li><li data-type='method' style='display: none;'><a href="Order.html#_fetchUser">_fetchUser</a></li><li data-type='method' style='display: none;'><a href="Order.html#_fetchOrderDetail">_fetchOrderDetail</a></li><li data-type='method' style='display: none;'><a href="Order.html#_fetchSpecialOffer">_fetchSpecialOffer</a></li><li data-type='method' style='display: none;'><a href="Order.html#_fetchSpecialOfferUser">_fetchSpecialOfferUser</a></li><li data-type='method' style='display: none;'><a href="Order.html#_fetchOrderNumber">_fetchOrderNumber</a></li></ul></li><li><a href="OrderDetail.html">OrderDetail</a></li><li><a href="OrderTax.html">OrderTax</a></li><li><a href="Promoter.html">Promoter</a></li><li><a href="Reservation.html">Reservation</a></li><li><a href="ReservationDetail.html">ReservationDetail</a></li><li><a href="Room.html">Room</a></li><li><a href="Seat.html">Seat</a></li><li><a href="Table.html">Table</a></li><li><a href="Ticket.html">Ticket</a></li><li><a href="UserShoppingCart.html">UserShoppingCart</a><ul class='methods'><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#setUser">setUser</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#setUserData">setUserData</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#setTicket">setTicket</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#setSeat">setSeat</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#addSpecialOffer">addSpecialOffer</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#setDiscount">setDiscount</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#setPayment">setPayment</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#empty">empty</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#del">del</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#pay">pay</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#create">create</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#update">update</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#delete">delete</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#fetch">fetch</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#fetchAll">fetchAll</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#getConnID">getConnID</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#getConnUserID">getConnUserID</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#getError">getError</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#generateUUID">generateUUID</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#getDateTime">getDateTime</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#_logMessage">_logMessage</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#_logError">_logError</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#logSocketMessage">logSocketMessage</a></li><li data-type='method' style='display: none;'><a href="UserShoppingCart.html#logSocketError">logSocketError</a></li></ul></li><li><a href="User.html">User</a><ul class='methods'><li data-type='method' style='display: none;'><a href="User.html#login">login</a></li><li data-type='method' style='display: none;'><a href="User.html#logout">logout</a></li><li data-type='method' style='display: none;'><a href="User.html#logoutToken">logoutToken</a></li><li data-type='method' style='display: none;'><a href="User.html#logoutTokenExpired">logoutTokenExpired</a></li><li data-type='method' style='display: none;'><a href="User.html#create">create</a></li><li data-type='method' style='display: none;'><a href="User.html#update">update</a></li><li data-type='method' style='display: none;'><a href="User.html#fetch">fetch</a></li><li data-type='method' style='display: none;'><a href="User.html#delete">delete</a></li><li data-type='method' style='display: none;'><a href="User.html#fetchByEmail">fetchByEmail</a></li><li data-type='method' style='display: none;'><a href="User.html#_hashPassword">_hashPassword</a></li><li data-type='method' style='display: none;'><a href="User.html#fetchAll">fetchAll</a></li><li data-type='method' style='display: none;'><a href="User.html#getConnID">getConnID</a></li><li data-type='method' style='display: none;'><a href="User.html#getConnUserID">getConnUserID</a></li><li data-type='method' style='display: none;'><a href="User.html#getError">getError</a></li><li data-type='method' style='display: none;'><a href="User.html#generateUUID">generateUUID</a></li><li data-type='method' style='display: none;'><a href="User.html#getDateTime">getDateTime</a></li><li data-type='method' style='display: none;'><a href="User.html#_logMessage">_logMessage</a></li><li data-type='method' style='display: none;'><a href="User.html#_logError">_logError</a></li><li data-type='method' style='display: none;'><a href="User.html#logSocketMessage">logSocketMessage</a></li><li data-type='method' style='display: none;'><a href="User.html#logSocketError">logSocketError</a></li></ul></li><li><a href="Socket.SocketPaymentSystemMPAY24.html">SocketPaymentSystemMPAY24</a></li><li><a href="Socket.html">Socket</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.html#onConnect">onConnect</a></li><li data-type='method' style='display: none;'><a href="Socket.html#onDisconnect">onDisconnect</a></li><li data-type='method' style='display: none;'><a href="Socket.html#onSetIntern">onSetIntern</a></li><li data-type='method' style='display: none;'><a href="Socket.html#onSetEvent">onSetEvent</a></li><li data-type='method' style='display: none;'><a href="Socket.html#onSetLanguage">onSetLanguage</a></li><li data-type='method' style='display: none;'><a href="Socket.html#_detectLang">_detectLang</a></li></ul></li><li><a href="Socket.SocketEvent.html">SocketEvent</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketEvent.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketEvent.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketEvent.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketEvent.html#onFetch">onFetch</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketEvent.html#onCheckPrefix">onCheckPrefix</a></li></ul></li><li><a href="Socket.SocketFloor.html">SocketFloor</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketFloor.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketFloor.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketFloor.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketFloor.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketForm.html">SocketForm</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketForm.html#onInit">onInit</a></li></ul></li><li><a href="Socket.SocketList.html">SocketList</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketList.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketList.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketList.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketList.html#onInit">onInit</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketList.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketLocation.html">SocketLocation</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketLocation.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketLocation.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketLocation.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketLocation.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketOrder.html">SocketOrder</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketOrder.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketOrder.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketOrder.html#onStorno">onStorno</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketOrder.html#onFetch">onFetch</a></li></ul></li><li></li><li><a href="Socket.SocketPromoter.html">SocketPromoter</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketPromoter.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketPromoter.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketPromoter.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketPromoter.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketReservation.html">SocketReservation</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketReservation.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketReservation.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketReservation.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketReservation.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketRoom.html">SocketRoom</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketRoom.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketRoom.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketRoom.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketRoom.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketScan.html">SocketScan</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketScan.html#onCreate">onCreate</a></li></ul></li><li><a href="Socket.SocketSeat.html">SocketSeat</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketSeat.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketSeat.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketSeat.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketSeat.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketTable.html">SocketTable</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketTable.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketTable.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketTable.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketTable.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketTicket.html">SocketTicket</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketTicket.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketTicket.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketTicket.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketTicket.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketUser.html">SocketUser</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketUser.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketUser.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketUser.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketUser.html#onLogin">onLogin</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketUser.html#onLogout">onLogout</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketUser.html#onLogoutByToken">onLogoutByToken</a></li></ul></li><li><a href="Socket.SocketShoppingCart.html">SocketShoppingCart</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketShoppingCart.html#onSetUser">onSetUser</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketShoppingCart.html#onSetTicket">onSetTicket</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketShoppingCart.html#onAddSeat">onAddSeat</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketShoppingCart.html#onAddSpecialOffer">onAddSpecialOffer</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketShoppingCart.html#onSetDiscount">onSetDiscount</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketShoppingCart.html#onSetUser">onSetUser</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketShoppingCart.html#onSetPayment">onSetPayment</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketShoppingCart.html#onDel">onDel</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketShoppingCart.html#onEmpty">onEmpty</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketShoppingCart.html#onCheckout">onCheckout</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">modules/user/shopping_cart.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import Module from './../module';
import Order from '../order/order';
import _ from 'lodash';

/**
 * user shopping cart actions
 * @extends Module
 */
class UserShoppingCart extends Module {

	/**
	 * constructor
	 * @param ClientConnID {String} 32 character string of connection ID from database table
	 */
	constructor(ClientConnID) {
		super(ClientConnID);
		this._userdata = SOCKET.io.sockets.connected[this._clientConnID].userdata;
		if (this._userdata.Event) {
			if (!_.isObject(this._userdata.ShoppingCart)) {
				this._userdata.ShoppingCart = {
					OrderEventID: this._userdata.Event.EventID,
					OrderLocationID: this._userdata.Event.EventLocationID,
					OrderPromoterID: this._userdata.Event.EventPromoterID,
					OrderState: (this._userdata.intern) ? 'payed' : 'open',
					OrderPayment: (this._userdata.intern) ? 'cash' : 'mpay',
					OrderFrom: (this._userdata.intern) ? 'intern' : 'extern',
					OrderFromID: (this._userdata.intern &amp;&amp; this._userdata.User &amp;&amp; this._userdata.User.UserID) ? this._userdata.User.UserID : null,
					OrderDetail: []
				}
			}
			if (!_.isArray(this._userdata.ShoppingCart.OrderDetail)) {
				this._userdata.ShoppingCart.OrderDetail = [];
			}

			if (_.isUndefined(_.find(this._userdata.ShoppingCart.OrderDetail, {OrderDetailType: 'handlingfee'}))) {
				let OrderDetailGrossRegular = (this._userdata.intern) ? this._userdata.Event.EventHandlingFeeGrossInternal : this._userdata.Event.EventHandlingFeeGrossExternal;
				if (OrderDetailGrossRegular || this._userdata.intern) {
					this._userdata.ShoppingCart.OrderDetail.push({
						ShoppingCartID: this.generateUUID(),
						ShoppingCartTicketName: this._userdata.Event.EventHandlingFeeName,
						OrderDetailType: 'handlingfee',
						OrderDetailTypeID: null,
						OrderDetailScanType: null,
						OrderDetailState: 'sold',
						OrderDetailSortOrder: 999,
						OrderDetailText: this._userdata.Event.EventHandlingFeeLabel,
						OrderDetailTaxPercent: this._userdata.Event.EventHandlingFeeTaxPercent,
						OrderDetailGrossRegular: OrderDetailGrossRegular,
						OrderDetailGrossDiscount: 0,
						OrderDetailGrossPrice: 0,
						OrderDetailTaxPrice: 0,
						OrderDetailNetPrice: 0
					});
				}
			}
			if (_.isUndefined(_.find(this._userdata.ShoppingCart.OrderDetail, {OrderDetailType: 'shippingcost'}))) {
				let OrderDetailGrossRegular = (this._userdata.intern) ? this._userdata.Event.EventShippingCostGrossInternal : this._userdata.Event.EventShippingCostGrossExternal;
				if (OrderDetailGrossRegular || this._userdata.intern) {
					this._userdata.ShoppingCart.OrderDetail.push({
						ShoppingCartID: this.generateUUID(),
						ShoppingCartTicketName: this._userdata.Event.EventShippingCostName,
						OrderDetailType: 'shippingcost',
						OrderDetailTypeID: null,
						OrderDetailScanType: null,
						OrderDetailState: 'sold',
						OrderDetailSortOrder: 998,
						OrderDetailText: this._userdata.Event.EventShippingCostLabel,
						OrderDetailTaxPercent: this._userdata.Event.EventShippingCostTaxPercent,
						OrderDetailGrossRegular: OrderDetailGrossRegular,
						OrderDetailGrossDiscount: 0,
						OrderDetailGrossPrice: 0,
						OrderDetailTaxPrice: 0,
						OrderDetailNetPrice: 0
					});
				}
			}
			let order = new Order(this._clientConnID);
			this._userdata.ShoppingCart = _.extend(this._userdata.ShoppingCart, order.calculate(this._userdata.ShoppingCart.OrderDetail));
		} else {

		}
	}

	/**
	 * set user for this shopping cart (used for internal connections eg 'admin' ||'promoter')
	 * @param UserID {String} 32 character string of user id
	 */
	setUser(UserID) {
		return new Promise((resolve, reject) => {
			if (this._userdata.Event) {
				let table = 'innoUser';
				let fields = null;
				let where = {UserID: UserID}
				DB.promiseSelect(table, fields, where).then(resUser => {
					let rowUser = resUser[0];
					this.setUserData(rowUser);
				}).catch(err => {
					console.log(err);
				});
			} else {
				reject('no event ist set');
			}
		});
	}

	/**
	 * set user data
	 * @param User {Object} object of user data
	 */
	setUserData(User) {
		_.extend(this._userdata.ShoppingCart, {
			UserID: !_.isUndefined(User.UserID) ? User.UserID : this._userdata.ShoppingCart.UserID,
			OrderUserCompany: !_.isUndefined(User.UserCompany) ? User.UserCompany : this._userdata.ShoppingCart.UserCompany,
			OrderUserCompanyUID: !_.isUndefined(User.UserCompanyUID) ? User.UserCompanyUID : this._userdata.ShoppingCart.UserCompanyUID,
			OrderUserGender: !_.isUndefined(User.UserGender) ? User.UserGender : this._userdata.ShoppingCart.UserGender,
			OrderUserTitle: !_.isUndefined(User.UserTitle) ? User.UserTitle : this._userdata.ShoppingCart.UserTitle,
			OrderUserFirstname: !_.isUndefined(User.UserFirstname) ? User.UserFirstname : this._userdata.ShoppingCart.UserFirstname,
			OrderUserLastname: !_.isUndefined(User.UserLastname) ? User.UserLastname : this._userdata.ShoppingCart.UserLastname,
			OrderUserStreet: !_.isUndefined(User.UserStreet) ? User.UserStreet : this._userdata.ShoppingCart.UserStreet,
			OrderUserCity: !_.isUndefined(User.UserCity) ? User.UserCity : this._userdata.ShoppingCart.UserCity,
			OrderUserZIP: !_.isUndefined(User.UserZIP) ? User.UserZIP : this._userdata.ShoppingCart.UserZIP,
			OrderUserCountryCountryISO2: !_.isUndefined(User.UserCountryCountryISO2) ? User.OrderUserCountryCountryISO2 : this._userdata.ShoppingCart.OrderUserCountryCountryISO2,
			OrderUserEmail: !_.isUndefined(User.UserEmail) ? User.UserEmail : this._userdata.ShoppingCart.UserEmail,
			OrderUserPhone1: !_.isUndefined(User.UserPhone1) ? User.UserPhone1 : this._userdata.ShoppingCart.UserPhone1,
			OrderUserPhone2: !_.isUndefined(User.UserPhone2) ? User.UserPhone2 : this._userdata.ShoppingCart.UserPhone2,
			OrderUserFax: !_.isUndefined(User.UserFax) ? User.UserFax : this._userdata.ShoppingCart.UserFax,
			OrderUserHomepage: !_.isUndefined(User.UserHomepage) ? User.UserHomepage : this._userdata.ShoppingCart.UserHomepage,
			OrderUserLangCode: !_.isUndefined(User.OrderUserLangCode) ? User.OrderUserLangCode : this._userdata.ShoppingCart.OrderUserLangCode
		});
	}

	/**
	 * set ticket - multiple tickets (especially for external usage parameter Amount can be used)
	 * @param values {Object} Object
	 * @example
	 * {ID:'TicketID', Amount: 2}
	 * @returns {Promise&lt;any>}
	 */
	setTicket(values) {

		return new Promise((resolve, reject) => {
			if (this._userdata.Event) {

				let TicketID = values.ID;
				let Amount = values.Amount;

				let OrderDetail = [];
				_.each(this._userdata.ShoppingCart.OrderDetail, (Item) => {
					if (Item.OrderDetailTypeID !== TicketID) {
						OrderDetail.push(Item);
					}
				});
				this._userdata.ShoppingCart.OrderDetail = OrderDetail;

				if (Amount) {

					let soldTicket = 0;
					let actualVisitors = 0;

					DB.promiseSelect('viewEventTicketCountSold', null, {EventID: this._userdata.Event.EventID}).then(res => {
						let TicketCountSold = res;
						_.each(TicketCountSold, rowCountTicketSold => {
							if (rowCountTicketSold.Type === 'ticket') {
								actualVisitors += rowCountTicketSold.count;
							}
							if (rowCountTicketSold.TicketID === TicketID) {
								soldTicket = rowCountTicketSold.count;
							}
						});
						return DB.promiseSelect('innoTicket', null, {TicketID: TicketID, TicketEventID: this._userdata.Event.EventID});
					}).then(resTicket => {
						let maximumVisitors = this._userdata.Event.EventMaximumVisitors;
						let rowTicket = resTicket[0];
						_.each(SOCKET.io.sockets.connected, client => {
							if (client.id != this._clientConnID &amp;&amp; client.adapter.rooms[this._userdata.Event.EventID].sockets &amp;&amp; client.userdata.ShoppingCart &amp;&amp; client.userdata.ShoppingCart.OrderDetail) {
								_.each(client.userdata.ShoppingCart.OrderDetail, Detail => {
									if (Detail.OrderDetailTypeID === TicketID) {
										soldTicket++;
										if (rowTicket.TicketType === 'ticket') {
											actualVisitors++;
										}
									}
								});
							}
						});
						let availableTicket = rowTicket.TicketContingent - soldTicket;

						if (this._userdata.intern === false &amp;&amp; Amount > rowTicket.TicketMaximumOnline) {
							Amount = rowTicket.TicketMaximumOnline;
						}
						if (Amount > availableTicket) {
							Amount = availableTicket;
						}
						if (maximumVisitors &amp;&amp; rowTicket.TicketType === 'ticket' &amp;&amp; actualVisitors + Amount > maximumVisitors) {
							Amount = maximumVisitors - actualVisitors;
						}

						for (let i = 0; i &lt; Amount; i++) {
							this._userdata.ShoppingCart.OrderDetail.push({
								ShoppingCartID: this.generateUUID(),
								ShoppingCartTicketName: rowTicket.TicketName,
								OrderDetailType: rowTicket.TicketType,
								OrderDetailTypeID: rowTicket.TicketID,
								OrderDetailScanType: rowTicket.TicketScanType,
								OrderDetailState: 'sold',
								OrderDetailSortOrder: rowTicket.TicketSortOrder,
								OrderDetailText: rowTicket.TicketLable,
								OrderDetailTaxPercent: rowTicket.TicketTaxPercent,
								OrderDetailGrossRegular: rowTicket.TicketGrossPrice,
								OrderDetailGrossDiscount: 0,
								OrderDetailGrossPrice: 0,
								OrderDetailTaxPrice: 0,
								OrderDetailNetPrice: 0
							});
						}
						let order = new Order(this._clientConnID);
						this._userdata.ShoppingCart = _.extend(this._userdata.ShoppingCart, order.calculate(this._userdata.ShoppingCart.OrderDetail));

						SOCKET.io.to(this._userdata.Event.EventID).emit('shopping-cart-update-ticket', {
							TicketID: rowTicket.TicketID,
							TicketType: rowTicket.TicketType,
							TicketAvailable: availableTicket - Amount
						});
						resolve(this._userdata.ShoppingCart);

						let availableVisitors = maximumVisitors - actualVisitors - Amount;
						SOCKET.io.to(this._userdata.Event.EventID).emit('shopping-cart-update-event', {
							EventAvailableVisitors: (this._userdata.Event.EventMaximumVisitors) ? availableVisitors : null
						});

					}).catch(err => {
						console.log(err);
						reject();
					});
				} else {
					let order = new Order(this._clientConnID);
					this._userdata.ShoppingCart = _.extend(this._userdata.ShoppingCart, order.calculate(this._userdata.ShoppingCart.OrderDetail));
					resolve(this._userdata.ShoppingCart);
				}
			} else {
				reject('no event ist set');
			}
		});
	}

	/**
	 * add seat
	 * @param SeatID {String} 32 character string for ID of the seat
	 * @returns {Promise&lt;any>}
	 */
	setSeat(SeatID) {
		return new Promise((resolve, reject) => {
			if (this._userdata.Event) {
				DB.promiseSelect('viewEventSeat', null, {SeatEventID: this._userdata.Event.EventID, SeatID: SeatID}).then(resSeat => {
					if (_.size(resSeat)) {
						let rowSeat = resSeat[0];
						let action = 'add';
						if (rowSeat.SeatOrderID === null &amp;&amp; rowSeat.SeatReservationID === null) {
							_.each(SOCKET.io.sockets.connected, client => {
								if (client.adapter.rooms[this._userdata.Event.EventID].sockets &amp;&amp; client.userdata.ShoppingCart &amp;&amp; client.userdata.ShoppingCart.OrderDetail) {
									_.each(client.userdata.ShoppingCart.OrderDetail, Detail => {
										if (Detail.OrderDetailType === 'seat' &amp;&amp; Detail.OrderDetailTypeID === SeatID) {
											if (client.id != this._clientConnID) {
												action = 'blocked';
											} else {
												action = 'release';
											}
										}
									});
								}
							});
							if (action === 'add') {
								let text = (rowSeat.RoomLabel) ? rowSeat.RoomLabel : '';
								text += (rowSeat.TableLabel) ? ' ' + rowSeat.TableLabel : '';
								text += (rowSeat.SeatLabel) ? ' ' + rowSeat.SeatLabel : '';
								if (rowSeat.SeatRow &amp;&amp; rowSeat.SeatNumber) {
									text += ' ' + rowSeat.SeatRow + '/' + rowSeat.SeatNumber;
								} else if (rowSeat.TableNumber &amp;&amp; rowSeat.SeatNumber) {
									text += ' ' + rowSeat.TableNumber + '/' + rowSeat.SeatNumber;
								} else if (rowSeat.SeatNumber) {
									text += ' ' + rowSeat.SeatNumber;
								}
								this._userdata.ShoppingCart.OrderDetail.push({
									ShoppingCartID: this.generateUUID(),
									ShoppingCartSeatName: rowSeat.SeatName,
									ShoppingCartRoomName: rowSeat.RoomName,
									ShoppingCartTableName: rowSeat.TableName,
									ShoppingCartTableNumber: rowSeat.TableNumber,
									OrderDetailType: 'seat',
									OrderDetailTypeID: rowSeat.SeatID,
									OrderDetailScanType: 'single',
									OrderDetailState: 'sold',
									OrderDetailSortOrder: 0,
									OrderDetailText: text.trim(),
									OrderDetailTaxPercent: rowSeat.SeatTaxPercent,
									OrderDetailGrossRegular: rowSeat.SeatGrossPrice,
									OrderDetailGrossDiscount: 0,
									OrderDetailGrossPrice: 0,
									OrderDetailTaxPrice: 0,
									OrderDetailNetPrice: 0
								});
							} else if (action === 'release') {
								let OrderDetail = [];
								_.each(this._userdata.ShoppingCart.OrderDetail, (Item) => {
									if (Item.OrderDetailTypeID !== SeatID) {
										OrderDetail.push(Item);
									}
								});
								this._userdata.ShoppingCart.OrderDetail = OrderDetail;
							}
							if (action !== 'blocked') {
								let order = new Order(this._clientConnID);
								this._userdata.ShoppingCart = _.extend(this._userdata.ShoppingCart, order.calculate(this._userdata.ShoppingCart.OrderDetail));
								let res = {
									SeatID: SeatID,
									SeatState: (action === 'release') ? 'free' : 'blocked'
								};
								SOCKET.io.to(this._userdata.Event.EventID).emit('shopping-cart-update-seat', res);
								resolve(this._userdata.ShoppingCart);

							} else {
								reject({SeatID: SeatID, SeatState: 'blocked'});
							}
						} else {
							if (rowSeat.SeatOrderID !== null) {
								reject({SeatID: SeatID, SeatState: 'sold'});
							} else if (rowSeat.SeatReservationID !== null) {
								reject({SeatID: SeatID, SeatState: 'reserved'});
							} else {
								reject({SeatID: SeatID, SeatState: 'blocked'});
							}
						}
					} else {
						reject(false);
					}
				}).catch(err => {
					console.log(err);
					reject();
				});
			} else {
				reject('no event ist set');
			}
		});
	}

	/**
	 * add special offer to shopping cart (not a special ticket !!!)
	 * @param values {Object} arra
	 * @returns {Promise&lt;any>}
	 */
	addSpecialOffer(values) {
		return new Promise((resolve, reject) => {
			if (this._userdata.Event) {
				resolve(values);
			} else {
				reject('no event ist set');
			}
		});
	}

	/**
	 * set discount to shopping cart (order) item
	 * only allowd from intern user 'admin' or 'promoter'
	 * @param values {Object} Object
	 * @example
	 * {ID:'ShoppingCartDetailID', Discount: 1.23}
	 * @returns {Promise&lt;any>}
	 */
	setDiscount(values) {
		return new Promise((resolve, reject) => {
			if (this._userdata.Event) {
				if (this._userdata.Event) {
					if (this._userdata.intern) {
						let OrderDetail = _.find(this._userdata.ShoppingCart.OrderDetail, {ShoppingCartID: values.ID});
						OrderDetail.OrderDetailGrossDiscount = values.Discount;
						let order = new Order(this._clientConnID);
						this._userdata.ShoppingCart = _.extend(this._userdata.ShoppingCart, order.calculate(this._userdata.ShoppingCart.OrderDetail));
						resolve(this._userdata.ShoppingCart);
					} else {
						reject('user not administrator');
					}
				} else {
					reject('user not logged in')
				}
			} else {
				reject('no event ist set');
			}
		});
	}

	/**
	 * set payment type
	 * @param Payment {String} on of 'cash' || 'mpay' || 'paypal' || 'transfer'
	 */
	setPayment(Payment) {
		return new Promise((resolve, reject) => {
			if (this._userdata.Event) {
				if (Payment === 'cash' || Payment === 'mpay' || Payment === 'paypal' || Payment === 'transfer') {
					if (this._userdata.intern || (!this._userdata.intern &amp;&amp; (Payment === 'mpay' || Payment === 'paypal'))) {
						this._userdata.ShoppingCart.OrderPayment = Payment;
						resolve(true);
					} else {
						reject('payment \'' + Payment + '\' is for external user not one of \'mpay\' || \'paypal\'');
					}
				} else {
					reject('payment \'' + Payment + '\' is not one of \'cash\' || \'mpay\' || \'paypal\' || \'transfer\'');
				}
			} else {
				reject('no event ist set');
			}
		});
	}

	/**
	 * empty shopping cart
	 * @returns {Promise&lt;any>}
	 */
	empty() {
		return new Promise((resolve, reject) => {
			this._userdata.ShoppingCart = null;
			resolve(null);
		});
	}

	/**
	 * delete item from shopping cart by unique ID
	 * @param DetailID {String} 32 character string one of ID ShoppingCart.OrderDetail[].ShoppingCartID
	 * @returns {Promise&lt;any>}
	 */
	del(DetailID) {
		return new Promise((resolve, reject) => {
			if (this._userdata.Event) {
				let OrderDetail = [];
				_.each(this._userdata.ShoppingCart.OrderDetail, Detail => {
					if (Detail.ShoppingCartID !== DetailID) {
						OrderDetail.push(Detail);
					}
				});
				this._userdata.ShoppingCart.OrderDetail = OrderDetail;
				let order = new Order(this._clientConnID);
				this._userdata.ShoppingCart = _.extend(this._userdata.ShoppingCart, order.calculate(this._userdata.ShoppingCart.OrderDetail));
				resolve(true);
			} else {
				reject('no event ist set');
			}
		});
	}

	/**
	 * start pay process
	 */
	pay() {

	}

}

module.exports = UserShoppingCart;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sat May 04 2019 13:50:11 GMT+0200 (GMT+02:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/jquery-3.1.1.min.js"></script>

<script src="scripts/search.js"></script>


<script src="scripts/collapse.js"></script>



</body>
</html>
