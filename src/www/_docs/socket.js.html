<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>socket.js - Documentation</title>
    
    
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://myproject.com" target="_blank" class="menu-item" id="website_link" >Project Website</a></h2><h2><a href="https://myproject.com.forum" target="_blank" class="menu-item" id="forum_link" >Forum</a></h2><h3>Classes</h3><ul><li><a href="MySql.html">MySql</a><ul class='methods'><li data-type='method'><a href="MySql.html#query">query</a></li><li data-type='method'><a href="MySql.html#promiseQuery">promiseQuery</a></li><li data-type='method'><a href="MySql.html#promiseInsert">promiseInsert</a></li><li data-type='method'><a href="MySql.html#promiseSelect">promiseSelect</a></li><li data-type='method'><a href="MySql.html#promiseUpdate">promiseUpdate</a></li><li data-type='method'><a href="MySql.html#promiseDelete">promiseDelete</a></li><li data-type='method'><a href="MySql.html#promiseCount">promiseCount</a></li><li data-type='method'><a href="MySql.html#promiseArchive">promiseArchive</a></li><li data-type='method'><a href="MySql.html#_where">_where</a></li><li data-type='method'><a href="MySql.html#_order">_order</a></li><li data-type='method'><a href="MySql.html#_log">_log</a></li></ul></li><li><a href="Helpers.html">Helpers</a><ul class='methods'><li data-type='method'><a href="Helpers.html#generateUUID">generateUUID</a></li><li data-type='method'><a href="Helpers.html#_logMessage">_logMessage</a></li><li data-type='method'><a href="Helpers.html#_logError">_logError</a></li></ul></li><li><a href="Http.html">Http</a></li><li><a href="Base.html">Base</a><ul class='methods'><li data-type='method'><a href="Base.html#init">init</a></li><li data-type='method'><a href="Base.html#connection">connection</a></li><li data-type='method'><a href="Base.html#disconnect">disconnect</a></li><li data-type='method'><a href="Base.html#setConnectionLanguage">setConnectionLanguage</a></li></ul></li><li><a href="Event.html">Event</a></li><li><a href="Floor.html">Floor</a><ul class='methods'><li data-type='method'><a href="Floor.html#fetchAllByEvent">fetchAllByEvent</a></li><li data-type='method'><a href="Floor.html#fetchAllByLocation">fetchAllByLocation</a></li></ul></li><li><a href="List.html">List</a><ul class='methods'><li data-type='method'><a href="List.html#create">create</a></li><li data-type='method'><a href="List.html#update">update</a></li><li data-type='method'><a href="List.html#init">init</a></li><li data-type='method'><a href="List.html#fetch">fetch</a></li><li data-type='method'><a href="List.html#_promiseList">_promiseList</a></li><li data-type='method'><a href="List.html#_promiseListColumn">_promiseListColumn</a></li></ul></li><li><a href="Location.html">Location</a><ul class='methods'><li data-type='method'><a href="Location.html#fetchAllByEvent">fetchAllByEvent</a></li><li data-type='method'><a href="Location.html#fetchAllByLocation">fetchAllByLocation</a></li></ul></li><li><a href="Module.html">Module</a><ul class='methods'><li data-type='method'><a href="Module.html#create">create</a></li><li data-type='method'><a href="Module.html#update">update</a></li><li data-type='method'><a href="Module.html#delete">delete</a></li><li data-type='method'><a href="Module.html#fetch">fetch</a></li><li data-type='method'><a href="Module.html#fetchAll">fetchAll</a></li><li data-type='method'><a href="Module.html#getConnID">getConnID</a></li><li data-type='method'><a href="Module.html#getConnUserID">getConnUserID</a></li><li data-type='method'><a href="Module.html#getError">getError</a></li><li data-type='method'><a href="Module.html#generateUUID">generateUUID</a></li><li data-type='method'><a href="Module.html#_logMessage">_logMessage</a></li><li data-type='method'><a href="Module.html#_logError">_logError</a></li></ul></li><li><a href="User.html">User</a><ul class='methods'><li data-type='method'><a href="User.html#login">login</a></li><li data-type='method'><a href="User.html#logout">logout</a></li><li data-type='method'><a href="User.html#logoutToken">logoutToken</a></li><li data-type='method'><a href="User.html#logoutTokenExpired">logoutTokenExpired</a></li><li data-type='method'><a href="User.html#create">create</a></li><li data-type='method'><a href="User.html#update">update</a></li><li data-type='method'><a href="User.html#delete">delete</a></li><li data-type='method'><a href="User.html#_hashPassword">_hashPassword</a></li><li data-type='method'><a href="User.html#fetch">fetch</a></li><li data-type='method'><a href="User.html#fetchAll">fetchAll</a></li><li data-type='method'><a href="User.html#getConnID">getConnID</a></li><li data-type='method'><a href="User.html#getConnUserID">getConnUserID</a></li><li data-type='method'><a href="User.html#getError">getError</a></li><li data-type='method'><a href="User.html#generateUUID">generateUUID</a></li><li data-type='method'><a href="User.html#_logMessage">_logMessage</a></li><li data-type='method'><a href="User.html#_logError">_logError</a></li></ul></li><li><a href="Socket.html">Socket</a><ul class='methods'><li data-type='method'><a href="Socket.html#connect">connect</a></li><li data-type='method'><a href="Socket.html#disconnect">disconnect</a></li><li data-type='method'><a href="Socket.html#setLangCode">setLangCode</a></li><li data-type='method'><a href="Socket.html#userCreate">userCreate</a></li><li data-type='method'><a href="Socket.html#userUpdate">userUpdate</a></li><li data-type='method'><a href="Socket.html#userDelete">userDelete</a></li><li data-type='method'><a href="Socket.html#userLogin">userLogin</a></li><li data-type='method'><a href="Socket.html#userLogout">userLogout</a></li><li data-type='method'><a href="Socket.html#userLogoutByToken">userLogoutByToken</a></li><li data-type='method'><a href="Socket.html#listCreate">listCreate</a></li><li data-type='method'><a href="Socket.html#listUpdate">listUpdate</a></li><li data-type='method'><a href="Socket.html#listDelete">listDelete</a></li><li data-type='method'><a href="Socket.html#listInit">listInit</a></li><li data-type='method'><a href="Socket.html#listFetch">listFetch</a></li><li data-type='method'><a href="Socket.html#formInit">formInit</a></li><li data-type='method'><a href="Socket.html#eventCreate">eventCreate</a></li><li data-type='method'><a href="Socket.html#eventUpdate">eventUpdate</a></li><li data-type='method'><a href="Socket.html#eventDelete">eventDelete</a></li><li data-type='method'><a href="Socket.html#eventFetch">eventFetch</a></li><li data-type='method'><a href="Socket.html#floorCreate">floorCreate</a></li><li data-type='method'><a href="Socket.html#floorUpdate">floorUpdate</a></li><li data-type='method'><a href="Socket.html#floorDelete">floorDelete</a></li><li data-type='method'><a href="Socket.html#floorFetch">floorFetch</a></li><li data-type='method'><a href="Socket.html#_detectLang">_detectLang</a></li><li data-type='method'><a href="Socket.html#_logMessage">_logMessage</a></li><li data-type='method'><a href="Socket.html#_logError">_logError</a></li><li data-type='method'><a href="Socket.html#generateUUID">generateUUID</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">socket.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import Io from 'socket.io';
import Helpers from './helpers';
import numeral from 'numeral';
import _ from 'lodash';
import randtoken from 'rand-token';
import SmtpClient from './mail/smtp_client';

// modules
import Base from './modules/base/base'
import Translation from './modules/translation/translation'
import User from './modules/user/user'
import List from './modules/list/list'
import Form from './modules/form/form'
import Event from './modules/event/event'
import Order from './modules/order/order'
import Floor from './modules/floor/floor'

const logPrefix = 'SOCKET  ';

/**
 * socket.io server connections&lt;br>
 * &lt;br>
 * IMPORTANT INFORMATION!&lt;br>
 * the examples which are shown here are for client side communication whith this server NOT for development&lt;br>
 *
 * @extends Helpers
 * @example
 * // use this code in your website
 * &lt;html>
 *    &lt;head>
 *        &lt;script type="text/javascript" src="/socket.io/socket.io.js">&lt;/script>
 *        &lt;script type="text/javascript">
 *          socket = io('localhost', {
 *              transports: ['websocket']
 *          });
 *        &lt;/script>
 *    &lt;/head>
 * &lt;/html>
 */
class Socket extends Helpers {

	/**
	 * basic class for socket server
	 * @param config {Object} configuration settings from ./../.config.yaml
	 */
	constructor(config) {
		super();

		if (config) {
			this._config = config;
		}

		this._clients = 0;

		// base, translation and account
		const base = new Base();
		base.init().then(() => {
			this.translation = new Translation();
			this.translation.init();
		}).then(() => {

			this._io = Io(this._config.http);
			this._io.on('connection', client => {

				// initialize a new client connection
				this.connect(client);

				// BASIC
				this.disconnect(client);
				this.setLangCode(client);

				// USER
				this.userCreate(client);
				this.userUpdate(client);
				this.userDelete(client);
				this.userLogin(client);
				this.userLogout(client);
				this.userLogoutByToken(client);

				// LIST
				this.listCreate(client);
				this.listUpdate(client);
				this.listDelete(client);
				this.listInit(client);
				this.listFetch(client);

				// FORM
				this.formInit(client);

				// EVENT
				this.eventCreate(client);
				this.eventUpdate(client);
				this.eventDelete(client);
				this.eventFetch(client);

				// FLOOOR
				this.floorCreate(client);
				this.floorUpdate(client);
				this.floorDelete(client);
				this.floorFetch(client);

			});
		}).catch((err) => {
			console.log(err);
		});

	}

	// BASE ================================================================================================
	/**
	 * connection&lt;br>
	 * a new websocket client has connected to the server&lt;br>
	 * update count and save connection data to database table `memClientConn`
	 * @param client {Object} socket.io connection object
	 */
	connect(client) {

		client.userdata = {
			UserID: null,
			ConnToken: randtoken.generate(32),
			LangCode: this._detectLang(client.handshake)
		}

		let values = {
			'ClientConnID': client.id,
			'ClientConnToken': client.userdata.ConnToken,
			'ClientConnLangCode': client.userdata.LangCode,
			'ClientConnAddress': (client.handshake &amp;&amp; client.handshake.address) ? client.handshake.address : '',
			'ClientConnUserAgent': (client.handshake &amp;&amp; client.handshake.headers &amp;&amp; client.handshake.headers["user-agent"]) ? client.handshake.headers["user-agent"] : ''
		};

		const base = new Base(client.id, client.userdata.UserID);
		base.connection(values).then(() => {
			this._clients++;
			this._logMessage(client, 'client connected', client.handshake);
		}).catch((err) => {
			this._logError(client, 'connection', err);
		});
	}

	/**
	 * disconnect&lt;br>
	 * client disconnected from server
	 * reduce number of connections and delete entry from database table `memClientConn`
	 * @param client {Object} socket.io connection object
	 */
	disconnect(client) {
		const evt = 'disconnect';
		client.on(evt, () => {
			const base = new Base(client.id, client.userdata.UserID);
			base.disconnect().then(() => {
				this._clients--;
				this._logMessage(client, evt);
			}).catch((err) => {
				this._logError(client, evt, err);
			});
		});
	}

	/**
	 * set language for connected client&lt;br>
	 * available language are stored in database table `feLang`
	 * @example
	 * socket.on('set-language', (res)=>{console.log(res);}); // the language for this client was set
	 * socket.emit('set-language', langCode); // sets the actual language for this connected client
	 * @param client {Object} socket.io connection object
	 */
	setLangCode(client) {
		const evt = 'set-language';
		client.on(evt, (LangCode) => {
			const base = new Base(client.id, client.userdata.UserID);
			base.setConnectionLanguage(LangCode).then((res) => {
				client.emit(evt, true);
				this._logMessage(client, evt, LangCode);
			}).catch((err) => {
				console.log(err);
			});
		});
	}

	// USER ================================================================================================
	/**
	 * user create&lt;br>
	 * create new user
	 * socket.on('user-create', (res)=>{console.log(res);}); // login success
	 * socket.on('user-create-err', (err)=>{console.log(err);}); // login error
	 * socket.emit('user-create', {
	 * 	'UserType': null,						// null = normal user (customer), 'admin' = administrator, 'promoter' = promoter
	 * 	'UserEmail': 'test1.test1@test1.at',
	 * 	'UserLangCode': 'de-at',
	 * 	'UserCompany': 'Test 1',
	 * 	'UserCompanyUID': 'AT Test 1',
	 * 	'UserGender': 'm',
	 * 	'UserTitle': 'Dr.',
	 * 	'UserFirstname': 'Test First Name 1',
	 * 	'UserLastname': 'Test Last Name 1',
	 * 	'UserStreet': 'Test Street 1',
	 * 	'UserCity': 'Test City 1',
	 * 	'UserZIP': '1234',
	 * 	'UserCountryCountryISO2': 'AT',
	 * 	'UserPassword': cryptPassword('abcdefg1'),
	 * 	'UserPasswordCheck': cryptPassword('abcdefg1')
	 * });
	 * @param client {Object} socket.io connection object
	 */
	userCreate(client) {
		const evt = 'user-create';
		client.on(evt, (req) => {
			const user = new User(client.id, client.userdata.UserID);
			user.create(req).then((res) => {
				client.emit(evt, res);
				this._logMessage(client, evt, res);
			}).catch((err) => {
				client.emit(evt + '-err', err);
				this._logError(client, evt, err);
			});
		});
	}

	/**
	 * user update&lt;br>
	 * update existing user
	 * @example
	 * socket.on('user-create', (res)=>{console.log(res);}); // login success
	 * socket.on('user-create-err', (err)=>{console.log(err);}); // login error
	 * socket.emit('user-create', {
	 * 	'UserID': 'ID of existing user',
	 * 	'UserType': null,									// null = normal user (customer), 'admin' = administrator, 'promoter' = promoter
	 * 	'UserEmail': 'test1.test1@test1.at',
	 * 	'UserLangCode': 'de-at',
	 * 	'UserCompany': 'Company 1',
	 * 	'UserCompanyUID': 'AT Test 1',
	 * 	'UserGender': 'm',									// m = male, f = female
	 * 	'UserTitle': 'Dr.',
	 * 	'UserFirstname': 'First Name 1',
	 * 	'UserLastname': 'Last Name 1',
	 * 	'UserStreet': 'Street 1',
	 * 	'UserCity': 'City 1',
	 * 	'UserZIP': '1234',
	 * 	'UserCountryCountryISO2': 'AT',
	 * 	'UserPassword': cryptPassword('abcdefg1!'),			// (md5(sha256(UserPassword))) https://github.com/emn178/js-sha256 and https://github.com/blueimp/JavaScript-MD5/blob/master/js/md5.min.js
	 * 	'UserPasswordCheck': cryptPassword('abcdefg1!')
	 * });
	 * @param client {Object} socket.io connection object
	 */
	userUpdate(client) {
		const evt = 'user-update';
		client.on(evt, (req) => {
			const user = new User(client.id, client.userdata.UserID);
			user.update(req).then((res) => {
				client.emit(evt, res);
				this._logMessage(client, evt, res);
			}).catch((err) => {
				client.emit(evt + '-err', err);
				this._logError(client, evt, err);
			});
		});
	}

	/**
	 * user delete&lt;br>
	 * delete existing user
	 * @example
	 * socket.on('user-delete', (res)=>{console.log(res);}); // response (full record)
	 * socket.on('user-delete-err', (err)=>{console.log(err);}); // error
	 * socket.emit('user-delete', 'ID of existing user');
	 * @param client {Object} socket.io connection object
	 */
	userDelete(client) {
		const evt = 'user-delete';
		client.on(evt, (id) => {
			const user = new User(client.id, client.userdata.UserID);
			user.delete(id).then((res) => {
				client.emit(evt, res);
				this._logMessage(client, evt, res);
			}).catch((err) => {
				client.emit(evt + '-err', err);
				this._logError(client, evt, err);
			});
		});
	}

	/**
	 * user login&lt;br>
	 * updates database table `memClientConn`
	 * @example
	 * socket.on('user-login', (res)=>{console.log(res);}); // login success
	 * socket.on('user-login-err', (err)=>{console.log(err);}); // login error
	 * socket.on('user-login-token', (res)=>{console.log(res);}); // login success but already logged in on other device. use user-logout-token to logout from other device
	 * socket.emit('user-login', {'UserEmail':email,'UserPassword':md5(sha256(password))}); // send login request
	 * @param client {Object} socket.io connection object
	 */
	userLogin(client) {
		const evt = 'user-login';
		client.on(evt, (req) => {
			const user = new User(client.id, client.userdata.UserID);
			user.login(req).then((res) => {
				client.lang = res.UserLangCode;
				if (!res.LogoutToken) {
					client.userdata.UserID = res.UserID;
					client.userdata.LangCode = res.UserLangCode;
					client.emit(evt, res);
					this._logMessage(client, evt, req);
				} else {
					client.emit('user-login-token', res.LogoutToken);
					this._logMessage(client, 'user-logout-token', req);
				}
			}).catch((err) => {
				client.emit(evt + '-err', err);
				this._logError(client, evt + '-err', req);
			});
		});
	}

	/**
	 * user logout&lt;br>
	 * updates database table `memClientConn`
	 * @example
	 * socket.on('user-logout', (res)=>{console.log(res);}); // logout success
	 * socket.emit('user-logout', null); // send logout request
	 * @param client {Object} socket.io connection object
	 */
	userLogout(client) {
		const evt = 'user-logout';
		client.on(evt, () => {
			const user = new User(client.id, client.userdata.UserID);
			user.logout().then((res) => {
				client.emit(evt, true);
				this._logMessage(client, evt);
			}).catch((err) => {
				client.emit(evt, err);
				this._logError(client, evt);
			});
		});
	}

	/**
	 * user logout by token&lt;br>
	 * updates database table `memClientConn`
	 * @example
	 * socket.on('user-logout-token', (res)=>{console.log(res);}); // user was logged out by token (effects all connected devices which where logged in with that user data)
	 * socket.emit('user-logout-token', token); // send token logout request. the value 'token' 128 characters was send by server on login request when a user tried to log in but was logged in on other device (mobile phone, browser tab, ...)
	 * @param client {Object} socket.io connection object
	 */
	userLogoutByToken(client) {
		const evt = 'user-logout-token';
		client.on(evt, (LogoutToken) => {
			const user = new User(client.id, client.userdata.UserID);
			user.logoutToken(LogoutToken).then((res) => {
				_.each(res, (row) => {
					this._io.to(`${row.ClientConnID}`).emit('user-logout', false);
					this._io.to(`${row.ClientConnID}`).emit('user-logout', true);
				});
				client.emit('user-logout', false);
			}).catch((err) => {
				this._logError(client, evt, err);
			});
		});
	}

	// LIST ================================================================================================
	/**
	 * list create&lt;br>
	 * create new list
	 * @example
	 * socket.on('list-create', (res)=>{console.log(res);}); // response (full record)
	 * socket.on('list-create-err', (err)=>{console.log(err);}); // error
	 * socket.emit('list-create', {
	 *	'ListName': 'Name',
	 *	'ListLabel': '§§LISTNAME',
	 *	'ListTable': 'database Table Name',
	 *	'ListPK': 'Name',
	 *	'ListMaskID': 'MaskID',
	 *	'ListLimit': 100,
	 *	'ListJSON': {"orderby": [{"FieldName1": ""}, {"FieldName2": "desc"}, {"FieldName3": ""}], "editable": 0},
	 *	'ListColumn': [{
	 *		'ListColumnOrder': 1,
	 *		'ListColumnName': 'Column_1',
	 *		'ListColumnType': 'text',
	 *		'ListColumnWidth': 150,
	 *		'ListColumnEditable': 0,
	 *		'ListColumnLabel': '§§Column1',
	 *		'ListColumnJSON': '{}'
	 *	}, {
	 *		'ListColumnOrder': 2,
	 *		'ListColumnName': 'Column_2',
	 *		'ListColumnType': 'text',
	 *		'ListColumnWidth': 150,
	 *		'ListColumnEditable': 0,
	 *		'ListColumnLabel': '§§Column2',
	 *		'ListColumnJSON': '{}'
	 *	}
	 * });
	 * @param client {Object} socket.io connection object
	 */
	listCreate(client) {
		const evt = 'list-create';
		client.on(evt, (req) => {
			const list = new List(client.id, client.userdata.UserID);
			list.create(req).then((res) => {
				client.emit(evt, res);
				this._logMessage(client, evt, res);
			}).catch((err) => {
				client.emit(evt + '-err', err);
				this._logError(client, evt, err);
			});
		});
	}

	/**
	 * list update&lt;br>
	 * update existing list
	 * @example
	 * socket.on('list-update', (res)=>{console.log(res);}); // response (full record)
	 * socket.on('list-update-err', (err)=>{console.log(err);}); // error
	 * socket.emit('list-update', {
	 *	'ListID': 'ID of existing list',
	 *	'ListName': 'Name',
	 *	'ListTable': 'database Table Name',
	 *	'ListPK': 'Name',
	 *	'ListMaskID': 'MaskID',
	 *	'ListLimit': 100,
	 *	'ListJSON': {"orderby": [{"FieldName1": ""}, {"FieldName2": "desc"}, {"FieldName3": ""}], "editable": 0},
	 *	'ListColumn': [{
	 *		'ListColumnOrder': 1,
	 *		'ListColumnName': 'Column 1',
	 *		'ListColumnType': 'text',
	 *		'ListColumnWidth': 150,
	 *		'ListColumnEditable': 0,
	 *		'ListColumnLabel': '§§Column1',
	 *		'ListColumnJSON': '{}'
	 *	}, {
	 *		'ListColumnOrder': 2,
	 *		'ListColumnName': 'Column 2',
	 *		'ListColumnType': 'text',
	 *		'ListColumnWidth': 150,
	 *		'ListColumnEditable': 0,
	 *		'ListColumnLabel': '§§Column2',
	 *		'ListColumnJSON': '{}'
	 *	}
	 * });
	 * @param client {Object} socket.io connection object
	 */
	listUpdate(client) {
		const evt = 'list-update';
		client.on(evt, (req) => {
			const list = new List(client.id, client.userdata.UserID);
			list.update(req).then((res) => {
				client.emit(evt, res);
				this._logMessage(client, evt, res);
			}).catch((err) => {
				client.emit(evt + '-err', err);
				this._logError(client, evt, err);
			});
		});
	}

	/**
	 * list delete&lt;br>
	 * delete existing list
	 * @example
	 * socket.on('list-delete', (res)=>{console.log(res);}); // response (full record)
	 * socket.on('list-delete-err', (err)=>{console.log(err);}); // error
	 * socket.emit('list-delete', 'ID of existing List');
	 * @param client {Object} socket.io connection object
	 */
	listDelete(client) {
		const evt = 'list-delete';
		client.on(evt, (id) => {
			const list = new List(client.id, client.userdata.UserID);
			list.delete(id).then((res) => {
				client.emit(evt, res);
				this._logMessage(client, evt, res);
			}).catch((err) => {
				client.emit(evt + '-err', err);
				this._logError(client, evt, err);
			});
		});
	}

	/**
	 * list init&lt;br>
	 * request a list configuration&lt;br>
	 * @example
	 * socket.on('list-init', (res)=>{console.log(res);}); // response (configuration of list and columns)
	 * socket.on('list-init-err', (err)=>{console.log(err);}); // error
	 * socket.emit('list-init', ListID); // request a list configuration
	 * @param client {Object} socket.io connection object
	 */
	listInit(client) {
		const evt = 'list-init';
		client.on(evt, (ListID) => {
			const list = new List(client.id, client.userdata.UserID);
			list.init(ListID).then((res) => {
				client.emit(evt, res);
				this._logMessage(client, evt);
			}).catch((err) => {
				client.emit(evt + '-err', err);
				this._logError(client, evt, err);
			});
		});
	}

	/**
	 * list fetch&lt;br>
	 * fetch list rows&lt;br>
	 * @example
	 * socket.on('list-fetch', (res)=>{console.log(res);}); // response (configuration of list and columns)
	 * socket.on('list-fetch-err', (err)=>{console.log(err);}); // error
	 * socket.emit('list-fetch', {"list-fetch", {"ListID":"feList","from":0,"orderby":null,"orderdesc":false}}); // request list rows
	 * @param client {Object} socket.io connection object
	 */
	listFetch(client) {
		const evt = 'list-fetch';
		client.on(evt, (req) => {
			req = {
				ListID: req.ListID,
				From: req.from,
				OrderBy: req.orderby,
				OrderDesc: req.orderdesc
			}
			const list = new List(client.id, client.userdata.UserID);
			list.fetch(req).then((res) => {
				client.emit(evt, res);
				this._logMessage(client, evt);
			}).catch((err) => {
				client.emit(evt + '-err', err);
				this._logError(client, evt, err);
			});
		});
	}

	// FORM ================================================================================================
	/**
	 * form init&lt;br>
	 * request a form configuration
	 * @example
	 * socket.on('form-init', (res)=>{console.log(res);}); // response (configuration of form and field)
	 * socket.on('form-init-err', (err)=>{console.log(err);}); // error
	 * socket.emit('form-init', ListID); // request a form configuration
	 * @param client {Object} socket.io connection object
	 */
	formInit(client) {
		const evt = 'form-init';
		client.on(evt, (req) => {
			const form = new Form(client.id, client.userdata.UserID);
			form.init(req.form_id).then((res) => {
				client.emit(evt, res);
				this._logMessage(client, evt);
			}).catch((err) => {
				client.emit(evt + '-err', err);
				this._logError(client, evt, err);
			});
		});
	}

	// EVENT ================================================================================================
	/**
	 * event create&lt;br>
	 * create new event
	 * @example
	 * socket.on('event-create', (res)=>{console.log(res);}); // response (full record)
	 * socket.on('event-create-err', (err)=>{console.log(err);}); // error
	 * socket.emit('event-create', {
	 *	'EventID': null,
	 *	'EventPromoterID': 'PromoterID | null',
	 *	'EventLocationID': 'LocationID | null',
	 *	'EventName': 'Event Name',
	 *	'EventPrefix': 'EPRE',
	 *	'EventPhone1': '+43123',
	 *	'EventPhone2': '+43456',
	 *	'EventFax': '+43789',
	 *	'EventEmail': 'event.email@test.tld',
	 *	'EventHomepage': 'http://eventhomepage.tld',
	 *	'EventSubdomain': 'epre-event-2019',
	 *	'EventStartBillNumber': 1234,
	 *	'EventMaximumSeats': 20,
	 *	'EventStepSeats': 2,
	 *	'EventDefaultTaxTicketPercent': 1.11,
	 *	'EventDefaultTaxSeatPercent': 1.22,
	 *	'EventStartDateTimeUTC': '2019-04-07 08:11:00',
	 *	'EventEndDateTimeUTC': '2019-04-07 08:12:00',
	 *	'EventSaleStartDateTimeUTC': '2019-04-07 08:13:00',
	 *	'EventSaleEndDateTimeUTC': '2019-04-07 08:14:00',
	 *	'EventScanStartDateTimeUTC': '2019-04-07 08:15:00',
	 *	'EventScanEndDateTimeUTC': '2019-04-07 08:16:00',
	 *	'EventInternalHandlingFeeGross': 2.11,
	 *	'EventInternalHandlingFeeTaxPercent': 2.22,
	 *	'EventInternalShippingCostGross': 2.33,
	 *	'EventInternalShippingCostTaxPercent': 2.44,
	 *	'EventExternalShippingCostGross': 2.55,
	 *	'EventExternalShippingCostTaxPercent': 2.66,
	 *	'EventExternalHandlingFeeGross': 2.77,
	 *	'EventExternalHandlingFeeTaxPercent': 2.88,
	 *	'EventSendMailAddress': 'event.email@test.tld',
	 *	'EventSendMailServer': 'smtp.test.tld',
	 *	'EventSendMailServerPort': 25,
	 *	'EventSendMailUsername': 'username',
	 *	'EventSendMailPassword': 'password',
	 *	'EventSendMailSettingsJSON': '{"test":"value"}',
	 *	'EventMpayTestFlag': 1,
	 *	'EventMpayMerchantID': '1234567890',
	 *	'EventMpaySoapPassword': 'passWD',
	 *	'EventMpayTestMerchantID': '0987654321',
	 *	'EventMpayTestSoapPassword': 'PASSwd'
	 * });
	 * @param client {Object} socket.io connection object
	 */
	eventCreate(client) {
		const evt = 'event-create';
		client.on(evt, (req) => {
			const event = new Event(client.id, client.userdata.UserID);
			event.create(req).then((res) => {
				client.emit(evt, res);
				this._logMessage(client, evt, res);
			}).catch((err) => {
				client.emit(evt + '-err', err);
				this._logError(client, evt, err);
			});
		});
	}

	/**
	 * event update&lt;br>
	 * update existing event
	 * @example
	 * socket.on('event-update', (res)=>{console.log(res);}); // response (full record)
	 * socket.on('event-update-err', (err)=>{console.log(err);}); // error
	 * socket.emit('event-update', {
	 *	'EventID': 'ID of existing event',
	 *	'EventPromoterID': 'PromoterID | null',
	 *	'EventLocationID': 'LocationID | null',
	 *	'EventName': 'Event Name',
	 *	'EventPrefix': 'EPRE',
	 *	'EventPhone1': '+43123',
	 *	'EventPhone2': '+43456',
	 *	'EventFax': '+43789',
	 *	'EventEmail': 'event.email@test.tld',
	 *	'EventHomepage': 'http://eventhomepage.tld',
	 *	'EventSubdomain': 'epre-event-2019',
	 *	'EventStartBillNumber': 1234,
	 *	'EventMaximumSeats': 20,
	 *	'EventStepSeats': 2,
	 *	'EventDefaultTaxTicketPercent': 1.11,
	 *	'EventDefaultTaxSeatPercent': 1.22,
	 *	'EventStartDateTimeUTC': '2019-04-07 08:11:00',
	 *	'EventEndDateTimeUTC': '2019-04-07 08:12:00',
	 *	'EventSaleStartDateTimeUTC': '2019-04-07 08:13:00',
	 *	'EventSaleEndDateTimeUTC': '2019-04-07 08:14:00',
	 *	'EventScanStartDateTimeUTC': '2019-04-07 08:15:00',
	 *	'EventScanEndDateTimeUTC': '2019-04-07 08:16:00',
	 *	'EventInternalHandlingFeeGross': 2.11,
	 *	'EventInternalHandlingFeeTaxPercent': 2.22,
	 *	'EventInternalShippingCostGross': 2.33,
	 *	'EventInternalShippingCostTaxPercent': 2.44,
	 *	'EventExternalShippingCostGross': 2.55,
	 *	'EventExternalShippingCostTaxPercent': 2.66,
	 *	'EventExternalHandlingFeeGross': 2.77,
	 *	'EventExternalHandlingFeeTaxPercent': 2.88,
	 *	'EventSendMailAddress': 'event.email@test.tld',
	 *	'EventSendMailServer': 'smtp.test.tld',
	 *	'EventSendMailServerPort': 25,
	 *	'EventSendMailUsername': 'username',
	 *	'EventSendMailPassword': 'password',
	 *	'EventSendMailSettingsJSON': '{"test":"value"}',
	 *	'EventMpayTestFlag': 1,
	 *	'EventMpayMerchantID': '1234567890',
	 *	'EventMpaySoapPassword': 'passWD',
	 *	'EventMpayTestMerchantID': '0987654321',
	 *	'EventMpayTestSoapPassword': 'PASSwd'
	 * });
	 * @param client {Object} socket.io connection object
	 */
	eventUpdate(client) {
		const evt = 'event-update';
		client.on(evt, (req) => {
			const event = new Event(client.id, client.userdata.UserID);
			event.update(req).then((res) => {
				client.emit(evt, res);
				this._logMessage(client, evt, res);
			}).catch((err) => {
				client.emit(evt + '-err', err);
				this._logError(client, evt, err);
			});
		});
	}

	/**
	 * event delete&lt;br>
	 * delete existing event
	 * @example
	 * socket.on('event-delete', (res)=>{console.log(res);}); // response (full record)
	 * socket.on('event-delete-err', (err)=>{console.log(err);}); // error
	 * socket.emit('event-delete', EventID);
	 * @param client {Object} socket.io connection object
	 */
	eventDelete(client) {
		const evt = 'event-delete';
		client.on(evt, (id) => {
			const event = new Event(client.id, client.userdata.UserID);
			event.delete(id).then((res) => {
				client.emit(evt, id);
				this._logMessage(client, evt, res);
			}).catch((err) => {
				client.emit(evt + '-err', err);
				this._logError(client, evt, err);
			});
		});
	}

	/**
	 * event fetch&lt;br>
	 * fetch event
	 * @example
	 * socket.on('event-fetch', (res)=>{console.log(res);}); // response (full record)
	 * socket.on('event-fetch-err', (err)=>{console.log(err);}); // error
	 * socket.emit('event-fetch', EventID);
	 * @param client {Object} socket.io connection object
	 */
	eventFetch(client) {
		const evt = 'event-fetch';
		client.on(evt, (id) => {
			const event = new Event(client.id, client.userdata.UserID);
			event.fetch(id).then((res) => {
				client.emit(evt, res);
				this._logMessage(client, evt, res);
			}).catch((err) => {
				client.emit(evt + '-err', err);
				this._logError(client, evt, err);
			});
		});
	}

	// FLOOR ================================================================================================
	/**
	 * floor create&lt;br>
	 * create a new floor
	 * @example
	 * socket.on('floor-create', (res)=>{console.log(res);}); // response (full record)
	 * socket.on('floor-create-err', (err)=>{console.log(err);}); // error
	 * socket.emit('floor-create', {
	 *	'FloorID': null,
	 *	'FloorEventID': 'EventID | null',
	 *	'FloorLocationID': 'LocationID | null',
	 *	'FloorName': 'Name',
	 *	'FloorSVG': 'SVG String | null'
	 * });
	 * @param client {Object} socket.io connection object
	 */
	floorCreate(client) {
		const evt = 'floor-create';
		client.on(evt, (req) => {
			const floor = new Floor(client.id, client.userdata.UserID);
			floor.create(req).then((res) => {
				client.emit(evt, res);
				this._logMessage(client, evt, res);
			}).catch((err) => {
				client.emit(evt + '-err', err);
				this._logError(client, evt, err);
			});
		});
	}

	/**
	 * floor update&lt;br>
	 * update existing floor
	 * @example
	 * socket.on('floor-update', (res)=>{console.log(res);}); // response (full record)
	 * socket.on('floor-update-err', (err)=>{console.log(err);}); // error
	 * socket.emit('floor-update', {
	 *	'FloorID': 'ID of existing floor',
	 *	'FloorEventID': 'EventID | null',
	 *	'FloorLocationID': 'LocationID | null',
	 *	'FloorName': 'Name',
	 *	'FloorSVG': 'SVG String | null'
	 * });
	 * @param client {Object} socket.io connection object
	 */
	floorUpdate(client) {
		const evt = 'floor-update';
		client.on(evt, (req) => {
			const floor = new Floor(client.id, client.userdata.UserID);
			floor.update(req).then((res) => {
				client.emit(evt, res);
				this._logMessage(client, evt, res);
			}).catch((err) => {
				client.emit(evt + '-err', err);
				this._logError(client, evt, err);
			});
		});
	}

	/**
	 * floor delete&lt;br>
	 * delete existing floor
	 * @example
	 * socket.on('floor-delete', (res)=>{console.log(res);}); // response (full record)
	 * socket.on('floor-delete-err', (err)=>{console.log(err);}); // error
	 * socket.emit('floor-delete', FloorID);
	 * @param client {Object} socket.io connection object
	 */
	floorDelete(client) {
		const evt = 'floor-delete';
		client.on(evt, (id) => {
			const floor = new Floor(client.id, client.userdata.UserID);
			floor.delete(id).then((res) => {
				client.emit(evt, id);
				this._logMessage(client, evt, res);
			}).catch((err) => {
				client.emit(evt + '-err', err);
				this._logError(client, evt, err);
			});
		});
	}

	/**
	 * floor fetch&lt;br>
	 * fetch floor
	 * @example
	 * socket.on('floor-fetch', (res)=>{console.log(res);}); // response (full record)
	 * socket.on('floor-fetch-err', (err)=>{console.log(err);}); // error
	 * socket.emit('floor-fetch', FloorID);
	 * @param client {Object} socket.io connection object
	 */
	floorFetch(client) {
		const evt = 'floor-fetch';
		client.on(evt, (id) => {
			const floor = new Floor(client.id, client.userdata.UserID);
			floor.fetch(id).then((res) => {
				client.emit(evt, res);
				this._logMessage(client, evt, res);
			}).catch((err) => {
				client.emit(evt + '-err', err);
				this._logError(client, evt, err);
			});
		});
	}


	/**
	 * detect browser language from connection handshake object
	 * @param handshake
	 * @returns {string}
	 * @private
	 */
	_detectLang(handshake) {
		let LangCode = 'en-gb';
		if (handshake &amp;&amp; handshake.headers &amp;&amp; handshake.headers["accept-language"]) {
			LangCode = handshake.headers["accept-language"];
		}
		return LangCode.toLowerCase().substr(0, 5);
	}

	/**
	 * log message
	 * @param client {Object} socket.io connection object
	 * @param evt {String} event
	 * @param message {Object} message
	 * @private
	 */
	_logMessage(client = null, evt = '', message = '') {
		message = numeral(this._clients).format('0000') + ' => ' + client.id + ' => ' + client.userdata.UserID + ' => ' + evt + ' => ' + JSON.stringify(message);
		log.msg(logPrefix, message);
	}

	/**
	 * log error
	 * @param client {Object} socket.io connection object
	 * @param evt {String} event
	 * @param message {Object} message
	 * @private
	 */
	_logError(client = null, evt = '', message = '') {
		message = numeral(this._clients).format('0000') + ' => ' + client.id + ' => ' + client.userdata.UserID + ' => ' + evt + ' => ' + JSON.stringify(message);
		log.err(logPrefix, message);
	}

};

module.exports = Socket;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sun Apr 07 2019 12:03:43 GMT+0200 (GMT+02:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/jquery-3.1.1.min.js"></script>

<script src="scripts/search.js"></script>




</body>
</html>
