<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>modules/order/order.js - Documentation</title>
    
    
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://myproject.com" target="_blank" class="menu-item" id="website_link" >Project Website</a></h2><h2><a href="https://myproject.com.forum" target="_blank" class="menu-item" id="forum_link" >Forum</a></h2><h3>Namespaces</h3><ul><li></li></ul><h3>Classes</h3><ul><li><a href="MySql.html">MySql</a><ul class='methods'><li data-type='method' style='display: none;'><a href="MySql.html#query">query</a></li><li data-type='method' style='display: none;'><a href="MySql.html#promiseQuery">promiseQuery</a></li><li data-type='method' style='display: none;'><a href="MySql.html#promiseInsert">promiseInsert</a></li><li data-type='method' style='display: none;'><a href="MySql.html#promiseSelect">promiseSelect</a></li><li data-type='method' style='display: none;'><a href="MySql.html#promiseUpdate">promiseUpdate</a></li><li data-type='method' style='display: none;'><a href="MySql.html#promiseDelete">promiseDelete</a></li><li data-type='method' style='display: none;'><a href="MySql.html#promiseCount">promiseCount</a></li><li data-type='method' style='display: none;'><a href="MySql.html#promiseArchive">promiseArchive</a></li><li data-type='method' style='display: none;'><a href="MySql.html#_where">_where</a></li><li data-type='method' style='display: none;'><a href="MySql.html#_order">_order</a></li><li data-type='method' style='display: none;'><a href="MySql.html#_log">_log</a></li></ul></li><li><a href="Helpers.html">Helpers</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Helpers.html#generateUUID">generateUUID</a></li><li data-type='method' style='display: none;'><a href="Helpers.html#getDateTime">getDateTime</a></li><li data-type='method' style='display: none;'><a href="Helpers.html#_logMessage">_logMessage</a></li><li data-type='method' style='display: none;'><a href="Helpers.html#_logError">_logError</a></li><li data-type='method' style='display: none;'><a href="Helpers.html#logSocketMessage">logSocketMessage</a></li><li data-type='method' style='display: none;'><a href="Helpers.html#logSocketError">logSocketError</a></li></ul></li><li><a href="Http.html">Http</a></li><li><a href="Event.html">Event</a></li><li><a href="Floor.html">Floor</a></li><li><a href="List.html">List</a><ul class='methods'><li data-type='method' style='display: none;'><a href="List.html#create">create</a></li><li data-type='method' style='display: none;'><a href="List.html#update">update</a></li><li data-type='method' style='display: none;'><a href="List.html#init">init</a></li><li data-type='method' style='display: none;'><a href="List.html#fetch">fetch</a></li><li data-type='method' style='display: none;'><a href="List.html#_promiseList">_promiseList</a></li><li data-type='method' style='display: none;'><a href="List.html#_promiseListColumn">_promiseListColumn</a></li></ul></li><li><a href="Location.html">Location</a></li><li><a href="Module.html">Module</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Module.html#create">create</a></li><li data-type='method' style='display: none;'><a href="Module.html#update">update</a></li><li data-type='method' style='display: none;'><a href="Module.html#delete">delete</a></li><li data-type='method' style='display: none;'><a href="Module.html#fetch">fetch</a></li><li data-type='method' style='display: none;'><a href="Module.html#fetchAll">fetchAll</a></li><li data-type='method' style='display: none;'><a href="Module.html#getConnID">getConnID</a></li><li data-type='method' style='display: none;'><a href="Module.html#getConnUserID">getConnUserID</a></li><li data-type='method' style='display: none;'><a href="Module.html#getError">getError</a></li><li data-type='method' style='display: none;'><a href="Module.html#generateUUID">generateUUID</a></li><li data-type='method' style='display: none;'><a href="Module.html#getDateTime">getDateTime</a></li><li data-type='method' style='display: none;'><a href="Module.html#_logMessage">_logMessage</a></li><li data-type='method' style='display: none;'><a href="Module.html#_logError">_logError</a></li><li data-type='method' style='display: none;'><a href="Module.html#logSocketMessage">logSocketMessage</a></li><li data-type='method' style='display: none;'><a href="Module.html#logSocketError">logSocketError</a></li></ul></li><li><a href="Order.html">Order</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Order.html#create">create</a></li><li data-type='method' style='display: none;'><a href="Order.html#delete">delete</a></li><li data-type='method' style='display: none;'><a href="Order.html#cancel">cancel</a></li><li data-type='method' style='display: none;'><a href="Order.html#_createOrderDetail">_createOrderDetail</a></li><li data-type='method' style='display: none;'><a href="Order.html#_createOrderTax">_createOrderTax</a></li><li data-type='method' style='display: none;'><a href="Order.html#_createPDF">_createPDF</a></li><li data-type='method' style='display: none;'><a href="Order.html#_fetchUser">_fetchUser</a></li><li data-type='method' style='display: none;'><a href="Order.html#_fetchOrderDetail">_fetchOrderDetail</a></li><li data-type='method' style='display: none;'><a href="Order.html#_fetchSpecialOffer">_fetchSpecialOffer</a></li><li data-type='method' style='display: none;'><a href="Order.html#_fetchSpecialOfferUser">_fetchSpecialOfferUser</a></li><li data-type='method' style='display: none;'><a href="Order.html#_fetchOrderNumber">_fetchOrderNumber</a></li></ul></li><li><a href="OrderDetail.html">OrderDetail</a></li><li><a href="OrderTax.html">OrderTax</a></li><li><a href="Promoter.html">Promoter</a></li><li><a href="Reservation.html">Reservation</a></li><li><a href="ReservationDetail.html">ReservationDetail</a></li><li><a href="Room.html">Room</a></li><li><a href="Seat.html">Seat</a></li><li><a href="Table.html">Table</a></li><li><a href="Ticket.html">Ticket</a></li><li><a href="User.html">User</a><ul class='methods'><li data-type='method' style='display: none;'><a href="User.html#login">login</a></li><li data-type='method' style='display: none;'><a href="User.html#logout">logout</a></li><li data-type='method' style='display: none;'><a href="User.html#logoutToken">logoutToken</a></li><li data-type='method' style='display: none;'><a href="User.html#logoutTokenExpired">logoutTokenExpired</a></li><li data-type='method' style='display: none;'><a href="User.html#create">create</a></li><li data-type='method' style='display: none;'><a href="User.html#update">update</a></li><li data-type='method' style='display: none;'><a href="User.html#fetch">fetch</a></li><li data-type='method' style='display: none;'><a href="User.html#delete">delete</a></li><li data-type='method' style='display: none;'><a href="User.html#_hashPassword">_hashPassword</a></li><li data-type='method' style='display: none;'><a href="User.html#fetchAll">fetchAll</a></li><li data-type='method' style='display: none;'><a href="User.html#getConnID">getConnID</a></li><li data-type='method' style='display: none;'><a href="User.html#getConnUserID">getConnUserID</a></li><li data-type='method' style='display: none;'><a href="User.html#getError">getError</a></li><li data-type='method' style='display: none;'><a href="User.html#generateUUID">generateUUID</a></li><li data-type='method' style='display: none;'><a href="User.html#getDateTime">getDateTime</a></li><li data-type='method' style='display: none;'><a href="User.html#_logMessage">_logMessage</a></li><li data-type='method' style='display: none;'><a href="User.html#_logError">_logError</a></li><li data-type='method' style='display: none;'><a href="User.html#logSocketMessage">logSocketMessage</a></li><li data-type='method' style='display: none;'><a href="User.html#logSocketError">logSocketError</a></li></ul></li><li><a href="Socket.SocketPaymentSystemMPAY24.html">SocketPaymentSystemMPAY24</a></li><li><a href="Socket.html">Socket</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.html#onConnect">onConnect</a></li><li data-type='method' style='display: none;'><a href="Socket.html#onDisconnect">onDisconnect</a></li><li data-type='method' style='display: none;'><a href="Socket.html#onSetLangCode">onSetLangCode</a></li><li data-type='method' style='display: none;'><a href="Socket.html#_detectLang">_detectLang</a></li></ul></li><li><a href="Socket.SocketEvent.html">SocketEvent</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketEvent.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketEvent.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketEvent.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketEvent.html#onFetch">onFetch</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketEvent.html#onCheckPrefix">onCheckPrefix</a></li></ul></li><li><a href="Socket.SocketFloor.html">SocketFloor</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketFloor.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketFloor.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketFloor.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketFloor.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketForm.html">SocketForm</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketForm.html#onInit">onInit</a></li></ul></li><li><a href="Socket.SocketList.html">SocketList</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketList.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketList.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketList.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketList.html#onInit">onInit</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketList.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketLocation.html">SocketLocation</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketLocation.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketLocation.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketLocation.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketLocation.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketOrder.html">SocketOrder</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketOrder.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketOrder.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketOrder.html#onStorno">onStorno</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketOrder.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketPromoter.html">SocketPromoter</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketPromoter.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketPromoter.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketPromoter.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketPromoter.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketReservation.html">SocketReservation</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketReservation.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketReservation.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketReservation.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketReservation.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketRoom.html">SocketRoom</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketRoom.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketRoom.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketRoom.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketRoom.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketScan.html">SocketScan</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketScan.html#onCreate">onCreate</a></li></ul></li><li><a href="Socket.SocketSeat.html">SocketSeat</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketSeat.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketSeat.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketSeat.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketSeat.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketTable.html">SocketTable</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketTable.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketTable.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketTable.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketTable.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketTicket.html">SocketTicket</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketTicket.html#onCreate">onCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketTicket.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketTicket.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketTicket.html#onFetch">onFetch</a></li></ul></li><li><a href="Socket.SocketUser.html">SocketUser</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Socket.SocketUser.html#userCreate">userCreate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketUser.html#onUpdate">onUpdate</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketUser.html#onDelete">onDelete</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketUser.html#onLogin">onLogin</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketUser.html#onLogout">onLogout</a></li><li data-type='method' style='display: none;'><a href="Socket.SocketUser.html#onLogoutByToken">onLogoutByToken</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">modules/order/order.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import Module from './../module';
import User from './../user/user';
import _ from 'lodash';
import randtoken from "rand-token";

/**
 * floor module
 */
class Order extends Module {

	/**
	 * constructor for order
	 * @param ConnID {String} 32 character string of connection ID
	 * @param ConnUserID {String} 32 character string of user ID
	 */
	constructor(ConnID = null, ConnUserID = null) {
		super(ConnID, ConnUserID);
		this.pk = 'OrderID';
		this.table = 'innoOrder';
		this.view = 'viewOrder';
		this.fields = {
			'OrderID': {'type': 'string', 'length': 32, 'empty': false}, // varchar(32) NOT NULL COMMENT 'unique id of the order',
			'OrderNumber': {'type': 'integer', 'length': 6, 'empty': false}, // int(6) UNSIGNED ZEROFILL NULL COMMENT 'consecutive number of the order (why 6 digits and not less => it could be a stadium with more than 100.000 visitors and orders)',
			'OrderNumberText': {'type': 'string', 'length': 14, 'empty': false}, // varchar(14) NULL COMMENT '7 character prefix delimiter (-) and consecutive number of the order (example: ZBB2020-123456)',
			'OrderEventID': {'type': 'string', 'length': 32, 'empty': false}, // varchar(32) NOT NULL COMMENT 'id of the event that order belongs to',
			'OrderType': {'type': 'enum', 'empty': false}, // enum('order','credit') NOT NULL DEFAULT 'order' COMMENT 'type of order => or=order (Rechnung) | cr=credit (Gutschrift)',
			'OrderState': {'type': 'enum', 'empty': false}, // enum('open','payed') NOT NULL DEFAULT 'open' COMMENT 'state of order => op=open | pa=payed',
			'OrderPayment': {'type': 'enum', 'empty': false}, // enum('cash','mpay','paypal','transfer') NOT NULL DEFAULT 'cash' COMMENT 'payment method => ca=cash | mp=mpay | pa=paypal | tr=transfer',
			'OrderCreditID': {'type': 'string', 'length': 32, 'empty': false}, // varchar(32) NULL COMMENT 'id of order to which this credit belongs to',
			'OrderDateTimeUTC': {'type': 'datetime', 'empty': false}, // datetime NOT NULL COMMENT 'order date time',
			'OrderPayedDateTimeUTC': {'type': 'datetime', 'empty': true}, // datetime NOT NULL COMMENT 'order date time payed',
			'OrderFromUserID': {'type': 'string', 'length': 32, 'empty': false}, // varchar(32) NULL COMMENT 'unique id of the user the order was created (only if OrderFrom = in)',
			'OrderUserID': {'type': 'string', 'length': 32, 'empty': false}, // varchar(32) NULL COMMENT 'unique id of the user that order belongs to',
			'OrderCompany': {'type': 'string', 'length': 150, 'empty': false}, // varchar(150) NULL COMMENT 'company',
			'OrderCompanyUID': {'type': 'string', 'length': 30, 'empty': false}, // varchar(30) NULL COMMENT 'company UID',
			'OrderGender': {'type': 'enum', 'empty': false}, // enum('m','f') NULL COMMENT 'gender m=male | f=female',
			'OrderTitle': {'type': 'string', 'length': 50, 'empty': true}, // varchar(50) NULL COMMENT 'academical title',
			'OrderFirstname': {'type': 'string', 'length': 50, 'empty': false}, // varchar(50) NULL COMMENT 'first name',
			'OrderLastname': {'type': 'string', 'length': 50, 'empty': false}, // varchar(50) NULL COMMENT 'last name',
			'OrderStreet': {'type': 'string', 'length': 120, 'empty': false}, // varchar(120) NULL COMMENT 'street',
			'OrderCity': {'type': 'string', 'length': 100, 'empty': false}, // varchar(100) NULL COMMENT 'city',
			'OrderZIP': {'type': 'string', 'length': 20, 'empty': false}, // varchar(20) NULL COMMENT 'zip',
			'OrderCountryCountryISO2': {'type': 'enum', 'table': 'feCountry', 'pk': 'CountryISO2', 'empty': true}, // varchar(2) NULL COMMENT 'country',
			'OrderUserEmail': {'type': 'string', 'length': 250, 'empty': false}, // varchar(250) NULL COMMENT 'actual email address of user => is used to send mail to customer',
			'OrderUserPhone1': {'type': 'string', 'length': 30, 'empty': false}, // varchar(30) NULL COMMENT 'actual phone number of user',
			'OrderUserPhone2': {'type': 'string', 'length': 30, 'empty': false}, // varchar(30) NULL COMMENT 'actual phone number of user',
			'OrderUserFax': {'type': 'string', 'length': 30, 'empty': false}, // varchar(30) NULL COMMENT 'actual phone number of user',
			'OrderUserHomepage': {'type': 'string', 'length': 250, 'empty': false}, // varchar(250) NULL COMMENT 'actual phone number of user',
			'OrderGrossPrice': {'type': 'decimal', 'length': '6,2', 'empty': false}, // decimal(8,2) NULL DEFAULT 0.00 COMMENT 'price gross => brutto',
			'OrderNetPrice': {'type': 'decimal', 'length': '3,2', 'empty': false}, // decimal(8,2) NULL DEFAULT 0.00 COMMENT 'price net => netto',
		}
	}

	/**
	 * create order
	 * @param values
	 * @returns {Promise&lt;any>}
	 */
	create(Order) {
		return new Promise((resolve, reject) => {

			let OrderUserID = Order.OrderUserID ? Order.OrderUserID : null;
			let OrderFromUserID = Order.OrderFromUserID ? Order.OrderFromUserID : null;

			_.extend(Order, {'OrderID': this.generateUUID()});

			let result = {};

			let Event = null;
			let User = null;
			let UserFrom = null;
			let OrderDetail = [];
			let SpecialOffer = [];
			let OrderTax = [];

			Order.OrderDateTimeUTC = this.getDateTime();

			db.promiseSelect('viewOrderEvent', null, {'EventID': Order.OrderEventID}).then((resEvent) => {
				if (_.size(resEvent)) {
					Event = resEvent[0];
				} else {
					Event = null;
				}
				return this._fetchUser(OrderUserID);
			}).then(resUser => {
				User = resUser;
				return this._fetchUser(OrderFromUserID);
			}).then(resUserFrom => {
				UserFrom = resUserFrom;
				return this._fetchSpecialOffer(Order.OrderSpecialOfferID, Order.OrderID);
			}).then((resSpecialOffer) => {
				SpecialOffer = resSpecialOffer;
				return this._fetchSpecialOfferUser(Order.SpecialOfferUserCode, Order.OrderID);
			}).then((resSpecialOffer) => {
				SpecialOffer = resSpecialOffer;
				return this._fetchOrderDetail(Order.OrderDetail, Order, Event, UserFrom ? true : false);
			}).then((resOrderDetail) => {
				// =================================================================
				// calculate some values like price and discount and taxes and so on
				// =================================================================
				OrderDetail = resOrderDetail;
				/*
				console.log('Event =============================');
				console.log(Event);

				console.log('User ==============================');
				console.log(User);

				console.log('UserFrom ==========================');
				console.log(UserFrom);

				console.log('SpecialOffer ======================');
				console.log(SpecialOffer);

				console.log('OrderDetail =======================');
				console.log(OrderDetail);

				console.log('OrderTax ==========================');
				console.log(OrderTax);

				console.log('OrderNumber =======================');
				console.log(OrderNumber);
				*/
				return this._fetchOrderNumber(Event);
			}).then((OrderNumber) => {

				if (_.size(OrderDetail)) {

					delete Order.OrderSpecialOfferUserCode;
					delete Order.OrderHandlingFeeGrossDiscount;
					delete Order.OrderShippingCostGrossDiscount;
					delete Order.OrderDetail;
					Order.OrderPromoterID = Event.EventPromoterID;

					return db.promiseInsert(this.table, Order);
				} else { // no detail products?
					return
				}
			}).then((resInsertOrder) => {
				if (_.size(OrderDetail)) {
					return db.promiseInsert('innoOrderDetail', OrderDetail);
				} else { // no detail products?
					return
				}
			}).then((resInsertDetail) => {
				return this._createOrderTax(OrderDetail, Order.OrderID);
			}).then((res) => {


				return this._createPDF(Order.OrderID);
			}).then((res) => {
				resolve(result);
			});
		});
	}

	/**
	 * delete for order is not allowed, only storno for items of order is available
	 */
	delete() {
		return new Promise((resolve, reject) => {
			resolve();
		});
	}

	/**
	 *
	 * @param OrderID {String} id of order which will be effected by this cancel
	 * @param ItemIDs {Array} array of item ids which will be effected for this cancel
	 * @returns {Promise&lt;any>}
	 */
	cancel(OrderID, ItemIDs) {
		return new Promise((resolve, reject) => {
			resolve();
		});
	}

	/**
	 * create order detail
	 * @param values
	 * @private
	 */
	_createOrderDetail(OrderDetail) {
		return new Promise((resolve, reject) => {
			db.promiseInsert('innoOrderDetail', OrderDetail).then(res => {
				resolve();
			}).catch(err => {
				console.log(err);
				reject(err);
			});
		});
	}

	/**
	 * create order tax
	 * @param values
	 * @returns {Promise&lt;any>}
	 * @private
	 */
	_createOrderTax(values) {
		return new Promise((resolve, reject) => {
			resolve();
		});
	}

	/**
	 * create PDF
	 * @param OrderID
	 * @private
	 */
	_createPDF(OrderID) {
		return new Promise((resolve, reject) => {
			resolve();
		});
	}

	/**
	 * fetch user
	 * @param UserID
	 * @returns {Promise&lt;any>}
	 * @private
	 */
	_fetchUser(UserID) {
		return new Promise((resolve, reject) => {
			if (UserID) {
				let user = new User(this.getConnID(), this.getConnUserID());
				user.fetch(UserID).then(res => {
					if (_.size(res)) {
						resolve(res[0]);
					} else {
						resolve(null);
					}
				}).catch(err => {
					reject(err);
				});
			} else {
				resolve(null);
			}
		});
	}

	/**
	 * fetch order detail
	 * @param Details {Array} array of order detail items
	 * @param Order {Object} object of order
	 * @param Event {Object} object of event
	 * @param internal {Boolean} is this internal order
	 * @returns {Promise&lt;any>}
	 * @private
	 */
	_fetchOrderDetail(Details, Order, Event, internal) {
		return new Promise((resolve, reject) => {

			let OrderID = Order.OrderID;
			let EventID = Event.EventID;
			let EventPrefix = Event.EventPrefix;

			let OrderType = 'External';
			if (internal) {
				OrderType = 'Internal';
			}

			let FeeCost = [];

			let HandlingFee = _.find(Details, {'OrderDetailType': 'handlingfee'});
			if (Event['EventHandlingFeeGross' + OrderType] || _.isObject(HandlingFee)) {
				let Detail = {
					OrderDetailType: 'handlingfee',
					OrderDetailTypeID: null,
					OrderDetailName: Event.EventHandlingFeeName ? Event.EventHandlingFeeName : 'Handling Fee',
					OrderDetailLabel: Event.EventHandlingFeeLabel ? Event.EventHandlingFeeLabel : null,
					OrderDetailScanType: 'noscan',
					OrderDetailGrossRegular: Event['EventHandlingFeeGross' + OrderType] ? Event['EventHandlingFeeGross' + OrderType] : 0,
					OrderDetailGrossDiscount: 0,
					OrderDetailGrossPrice: Event['EventHandlingFeeGross' + OrderType] ? Event['EventHandlingFeeGross' + OrderType] : 0,
					OrderDetailTaxPercent: Event.EventHandlingFeeTaxPercent ? Event.EventHandlingFeeTaxPercent : 0
				}
				if (internal) {
					if (HandlingFee &amp;&amp; _.isObject(HandlingFee)) {
						_.extend(Detail, HandlingFee);
						if (HandlingFee.OrderDetailGrossPrice) {
							Detail.OrderDetailGrossRegular = HandlingFee.OrderDetailGrossPrice;
						}
						if (HandlingFee.OrderDetailGrossDiscount) {
							Detail.OrderDetailGrossPrice = Detail.OrderDetailGrossPrice - HandlingFee.OrderDetailGrossDiscount;
						}
					}
				}
				_.extend(Detail, {
					'OrderDetailID': this.generateUUID(),
				});
				FeeCost.push(Detail);
			}

			if (internal) {
				let ShippingCost = _.find(Details, {'OrderDetailType': 'shippingcost'});
				if (Event.EventShippingCostGross || _.isObject(ShippingCost)) {
					let Detail = {
						OrderDetailType: 'shippingcost',
						OrderDetailTypeID: null,
						OrderDetailName: Event.EventShippingCostName ? Event.EventShippingCostName : 'Handling Fee',
						OrderDetailLabel: Event.EventShippingCostLabel ? Event.EventShippingCostLabel : null,
						OrderDetailScanType: 'noscan',
						OrderDetailGrossRegular: Event.EventShippingCostGross ? Event.EventShippingCostGross : 0,
						OrderDetailGrossDiscount: 0,
						OrderDetailGrossPrice: Event.EventShippingCostGross ? Event.EventShippingCostGross : 0,
						OrderDetailTaxPercent: Event.EventShippingCostTaxPercent ? Event.EventShippingCostTaxPercent : 0
					}
					if (ShippingCost &amp;&amp; _.isObject(ShippingCost)) {
						_.extend(Detail, ShippingCost);
						if (ShippingCost.OrderDetailGrossPrice) {
							Detail.OrderDetailGrossRegular = ShippingCost.OrderDetailGrossPrice;
						}
						if (ShippingCost.OrderDetailGrossDiscount) {
							Detail.OrderDetailGrossPrice = Detail.OrderDetailGrossPrice - ShippingCost.OrderDetailGrossDiscount;
						}
					}
					_.extend(Detail, {
						'OrderDetailID': this.generateUUID(),
					});
					FeeCost.push(Detail);
				}
			}

			let Items = []; // temporary store Details into Items Array (to split each item 'detail' into one big array => Amount of tickets or specials)
			_.each(Details, Detail => {
				if (Detail.OrderDetailType == 'ticket' || Detail.OrderDetailType == 'special') {
					Detail.Amount = (Detail.Amount) ? Detail.Amount : 1;
					for (var i = 0; i &lt; Detail.Amount; i++) {
						_.extend(Detail, {
							'OrderDetailID': this.generateUUID(),
						});
						Items.push(_.clone(Detail));
					}
				} else {
					_.extend(Detail, {
						'OrderDetailID': this.generateUUID(),
					});
					Items.push(_.clone(Detail));
				}
			});

			Details = FeeCost;
			let promiseSelect = [];
			let TicketID = [];
			let whereTicket = {conditions: 'TicketEventID=? AND (', values: [EventID]};
			let orTicket = '';
			let SeatID = [];
			let whereSeat = {conditions: 'SeatEventID=? AND (', values: [EventID]};
			let orSeat = '';
			_.each(Items, Detail => {
				if (Detail.OrderDetailType === 'ticket' || Detail.OrderDetailType === 'special') {
					if (TicketID.indexOf(Detail.OrderDetailTypeID) === -1) {
						whereTicket.conditions += orTicket + 'TicketID=?';
						orTicket = ' OR ';
						whereTicket.values.push(Detail.OrderDetailTypeID);
						TicketID.push(Detail.OrderDetailTypeID);
					}
				} else if (Detail.OrderDetailType === 'seat') {
					if (SeatID.indexOf(Detail.OrderDetailTypeID) === -1) {
						whereSeat.conditions += orSeat + 'SeatID=?';
						orSeat = ' OR ';
						whereSeat.values.push(Detail.OrderDetailTypeID);
						SeatID.push(Detail.OrderDetailTypeID);
					}
				}
			});

			if (_.size(TicketID)) {
				whereTicket.conditions += ')';
				promiseSelect.push(db.promiseSelect('viewOrderTicket', null, whereTicket));
			}

			if (_.size(SeatID)) {
				whereSeat.conditions += ')';
				promiseSelect.push(db.promiseSelect('viewOrderSeat', null, whereSeat));
			}

			Promise.all(promiseSelect).then(resSelect => {
				_.each(resSelect, rowSelect => {
					_.each(rowSelect, Detail => {
						if (!_.isUndefined(Detail.TicketID)) {
							_.each(Items, Detail => {
								if (Detail.OrderDetailType === 'ticket' || Detail.OrderDetailType === 'special') {
									let Ticket = _.find(rowSelect, {'TicketID': Detail.OrderDetailTypeID});
									if (Ticket) {
										let TicketScanType = Ticket.TicketScanType ? Ticket.TicketScanType : 'single';
										let TicketGrossPrice = Ticket.TicketGrossPrice ? Ticket.TicketGrossPrice : 0;
										let TicketTaxPercent = Ticket.TicketTaxPercent ? Ticket.TicketTaxPercent : 0;
										let OrderDetailGrossDiscount = Detail.OrderDetailGrossDiscount ? Detail.OrderDetailGrossDiscount : 0;
										_.extend(Detail, {
											OrderDetailScanType: TicketScanType,
											OrderDetailName: Ticket.TicketName,
											OrderDetailLabel: Ticket.TicketLable,
											OrderDetailGrossRegular: TicketGrossPrice,
											OrderDetailGrossDiscount: OrderDetailGrossDiscount,
											OrderDetailGrossPrice: TicketGrossPrice - OrderDetailGrossDiscount,
											OrderDetailTaxPercent: TicketTaxPercent ? TicketTaxPercent : 0
										});
										Details.push(Detail);
									}
								}
							});

						} else if (!_.isUndefined(Detail.SeatID)) {
							let Item = _.find(Items, {'OrderDetailTypeID': Detail.SeatID});
							if (Item) {
								let SeatState = Detail.SeatState ? Detail.SeatState : null;
								let SeatGrossPrice = Detail.SeatGrossPrice ? Detail.SeatGrossPrice : 0;
								let SeatTaxPercent = Detail.SeatTaxPercent ? Detail.SeatTaxPercent : 0;
								let OrderDetailGrossDiscount = Item.OrderDetailGrossDiscount ? Item.OrderDetailGrossDiscount : 0;
								_.extend(Item, {
									OrderDetailScanType: 'single',
									OrderDetailName: Detail.SeatName,
									OrderDetailNumber: Detail.SeatNumber,
									OrderDetailLabel: Detail.SeatLabel,
									OrderDetailState: SeatState,
									OrderDetailGrossRegular: SeatGrossPrice,
									OrderDetailGrossDiscount: OrderDetailGrossDiscount,
									OrderDetailGrossPrice: SeatGrossPrice - OrderDetailGrossDiscount,
									OrderDetailTaxPercent: SeatTaxPercent ? SeatTaxPercent : 0
								});
								if (Detail.SeatOrderID === null &amp;&amp; Detail.SeatReservationID === null &amp;&amp; Detail.SeatState === null) {
									Details.push(Item);
								} else { // ERROR: Seat already in order or reservation or wrong state!

								}
							}
						}
					});
				});

				let Ticket = _.filter(Details, {OrderDetailType: 'ticket'});
				let Special = _.filter(Details, {OrderDetailType: 'special'});
				let Seat = _.filter(Details, {OrderDetailType: 'seat'});
				let HandlingFee = _.filter(Details, {OrderDetailType: 'handlingfee'});
				let ShippingCost = _.filter(Details, {OrderDetailType: 'shippingcost'});

				let res = [];
				if (!_.isUndefined(Ticket) || !_.isUndefined(Special) || !_.isUndefined(Seat)) {
					let sortOrder = 1;
					_.each([Ticket, Special, Seat, HandlingFee, ShippingCost], Items => {
						if (!_.isUndefined(Items) &amp;&amp; _.isArray(Items)) {
							_.sortBy(Items, ['OrderDetailName', 'OrderDetailLabel']);
							_.each(Items, Item => {
								let GrossPrice = (Item.OrderDetailGrossPrice >= 0) ? Item.OrderDetailGrossPrice : 0;
								let TaxPercent = Item.OrderDetailTaxPercent;
								let TaxPrice = Math.ceil(((GrossPrice / (100 + TaxPercent)) * TaxPercent) * 100) / 100;
								let NetPrice = GrossPrice - TaxPrice;
								res.push({
									OrderDetailScanCode: EventPrefix + randtoken.generate(15 - EventPrefix.length),
									OrderDetailScanType: Item.OrderDetailScanType,
									OrderDetailOrderID: OrderID,
									OrderDetailType: Item.OrderDetailType,
									OrderDetailTypeID: Item.OrderDetailTypeID,
									OrderDetailState: 'sold',
									OrderDetailSortOrder: sortOrder,
									OrderDetailText: null,
									OrderDetailGrossRegular: Item.OrderDetailGrossRegular,
									OrderDetailGrossDiscount: Item.OrderDetailGrossDiscount,
									OrderDetailGrossPrice: GrossPrice,
									OrderDetailTaxPercent: TaxPercent,
									OrderDetailTaxPrice: TaxPrice,
									OrderDetailNetPrice: NetPrice
								});
								sortOrder++;
							});
						}
					});
				}

				resolve(res);
			}).catch(err => {
				reject(err);
			});
		});
	}

	/**
	 * special offer
	 * @param SpecialOfferID
	 * @returns {Promise&lt;any>}
	 * @private
	 */
	_fetchSpecialOffer(SpecialOfferID) {
		return new Promise((resolve, reject) => {
			if (SpecialOfferID) {
				db.promiseSelect('innoSpecialOffer', null, {'SpecialOfferID': SpecialOfferID}).then((res) => {

					return db.promiseSelect('innoSpecialOfferDetail', null, {'SpecialOfferDetailSpecialOfferID': SpecialOfferID});
				}).then(res => {

				});
			} else {
				resolve();
			}
		});
	}

	/**
	 * special offer with user code
	 * @param SpecialOfferUserCode
	 * @returns {Promise&lt;any>}
	 * @private
	 */
	_fetchSpecialOfferUser(SpecialOfferUserCode) {
		return new Promise((resolve, reject) => {
			resolve();
		});
	}

	/**
	 * create order number
	 * @param EventOrderNumberBy
	 * @param EventID
	 * @param EventPromoterID
	 * @returns {Promise&lt;any>}
	 * @private
	 */
	_fetchOrderNumber(Event) {
		// Event.EventOrderNumberBy, Event.EventID, Event.EventPromoterID
		return new Promise((resolve, reject) => {
			resolve();
		});
	}

}

module.exports = Order;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Apr 22 2019 16:21:21 GMT+0200 (GMT+02:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/jquery-3.1.1.min.js"></script>

<script src="scripts/search.js"></script>


<script src="scripts/collapse.js"></script>



</body>
</html>
